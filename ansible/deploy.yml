---
- name: Deploy Docker Images to Remote Server
  hosts: all:!localhost
  vars:    
    root_path: "{{ lookup('env', 'ROOT_PATH') }}"
    compose_path: "{{ root_path }}/.deployment/docker/docker-compose.yml"
    tmp_dir: "/tmp"
    framework_version: "1.0.48-dev38"
    decomposerize_types:
      - name: "setup"
        base_options: "--create-networks --create-volumes --stop-and-remove"
        ignore_errors: yes  # Networks/volumes might already exist
      - name: "run"
        base_options: "--docker-run --docker-run-detach"
        ignore_errors: no
  pre_tasks:
    - name: Display Dockflow version
      debug:
        msg: "Dockflow v{{ framework_version }}"
      run_once: true
      delegate_to: localhost

    - name: Load framework configuration
      import_role:
        name: load-config
      run_once: true
      delegate_to: localhost

    - name: Prepare deployment (render Docker templates)
      import_role:
        name: prepare-deployment
      run_once: true
      delegate_to: localhost

    - name: Load environment variables from YAML file
      include_vars:
        file: /tmp/ansible_env_vars.yml
      delegate_to: localhost
      run_once: true

    - name: Set computed variables
      set_fact:
        global_no_log: "{{ not (deployment_config.options.enable_debug_logs | default(false) | bool) }}"
        deploy_services: "{{ lookup('env', 'DEPLOY_DOCKER_SERVICES') | default('', true) }}"
        services_option: "{{ '--services=' + lookup('env', 'DEPLOY_DOCKER_SERVICES') if lookup('env', 'DEPLOY_DOCKER_SERVICES') else '' }}"
        environmentize_option: "{{ '--environmentize' if (deployment_config.options.environmentize | default(true) | bool) else '' }}"
        remote_build: "{{ deployment_config.options.remote_build | default(false) | bool }}"
        sanitized_branch_name: "{{ branch_name | regex_replace('[^a-zA-Z0-9-]', '_') }}"
      no_log: "{{ not (deployment_config.options.enable_debug_logs | default(false) | bool) }}"

    - name: Ensure rollback directory exists
      file:
        path: /var/lib/dockflow
        state: directory
        mode: '0755'
  roles:
    - role: geerlingguy.docker
    - role: nginx
      tags:
        - nginx
    - role: private_ssh_keys
    - role: services
    - role: image-tracking
    - role: local-build
      when: not (remote_build | bool)
      delegate_to: localhost
      run_once: true
    - role: remote-build
      when: remote_build | bool
    - role: image-transfer
      when: not (remote_build | bool)
    - role: execute-scripts
  tasks:
    - name: Check if rollback is configured
      set_fact:
        rollback_configured: "{{ (deployment_config.health_checks.on_failure | default('notify')) == 'rollback' }}"
      when: deployment_config is defined and deployment_config.health_checks is defined

    - name: Process Docker commands for each type
      include_tasks: playbooks/process_docker_commands.yml
      loop: "{{ decomposerize_types }}"
      loop_control:
        loop_var: cmd_type
      when: not (cmd_type.skip_on_rollback | default(false) and rollback_configured | default(false))

  post_tasks:
    - name: Set health checks configuration
      set_fact:
        health_checks_config: "{{ deployment_config.health_checks | default({}) }}"
      when: deployment_config is defined

    - name: Run health checks
      include_role:
        name: health-check
      when: health_checks_config is defined or (deployment_config.health_checks is defined)

    - name: Build list of newly deployed images for marking healthy
      set_fact:
        new_deployed_images: []
      changed_when: false

    - name: Populate new_deployed_images from aggregated docker run commands
      set_fact:
        new_deployed_images: "{{ new_deployed_images + [{'name': item.split() | last, 'timestamp': ansible_date_time.iso8601}] }}"
      loop: "{{ hostvars[inventory_hostname].get('all_docker_run_commands', []) }}"
      when: hostvars[inventory_hostname].get('all_docker_run_commands', []) | length > 0
      loop_control:
        label: "{{ item.split() | last }}"

    - name: Mark deployment as healthy if checks passed or disabled
      include_role:
        name: image-tracking
        tasks_from: mark_healthy
      vars:
        health_check_passed: "{{ (failed_health_checks | default([]) | length) == 0 }}"
      when: 
        - (failed_health_checks | default([]) | length) == 0 or not (health_checks_config.enabled | default(false))

    - name: Clean up old unhealthy images
      include_role:
        name: image-tracking
        tasks_from: cleanup
      when:
        - (failed_health_checks | default([]) | length) == 0 or not (health_checks_config.enabled | default(false))