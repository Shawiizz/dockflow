---
- name: Deploy Docker Images to Remote Server
  hosts: all:!localhost
  vars:    
    root_path: "{{ lookup('env', 'ROOT_PATH') }}"
    compose_path: "{{ root_path }}/.dockflow/docker/docker-compose.yml"
    framework_version: "2.0.18"
    dockflow_venv: /opt/dockflow-venv
  pre_tasks:
    - name: Ensure python3-venv is installed
      ansible.builtin.apt:
        name: python3-venv
        state: present
        update_cache: true
      become: true

    - name: Create Dockflow virtualenv with Docker SDK
      ansible.builtin.pip:
        name:
          - docker
          - jsondiff
        state: present
        virtualenv: "{{ dockflow_venv }}"
        virtualenv_command: python3 -m venv
      become: true

    - name: Set ansible_python_interpreter to use Dockflow venv
      ansible.builtin.set_fact:
        ansible_python_interpreter: "{{ dockflow_venv }}/bin/python"

    - name: Display Dockflow version
      debug:
        msg: "Dockflow v{{ framework_version }}"
      run_once: true
      delegate_to: localhost

    - name: Validate project_name is set
      fail:
        msg: |
          ERROR: project_name is required in config.yml
          
          Please add a project_name to your .dockflow/config.yml:
          
          project_name: "my-project-name"
          
          The project_name must contain only lowercase letters, numbers, and hyphens.
          It is used to identify your project and name the Docker Swarm stack.
      when: config.project_name is not defined or config.project_name == ''
      delegate_to: localhost
      run_once: true

    - name: Validate project_name format
      fail:
        msg: |
          ERROR: Invalid project_name format: {{ config.project_name }}
          
          The project_name must contain only lowercase letters, numbers, and hyphens.
          Example: my-app-name, webapp-v2, api-backend
      when: 
        - config.project_name is defined
        - not (config.project_name | regex_search('^[a-z0-9][a-z0-9-]*[a-z0-9]$|^[a-z0-9]$'))
      delegate_to: localhost
      run_once: true

    - name: Set computed variables
      set_fact:
        global_no_log: "{{ not (config.options.enable_debug_logs | default(false) | bool) }}"
        # Options from JSON context (with env fallback for backward compatibility)
        deploy_services: "{{ options.services | default(lookup('env', 'DEPLOY_DOCKER_SERVICES') | default('', true)) }}"
        skip_build: "{{ options.skip_build | default(lookup('env', 'SKIP_BUILD') | default('false', true)) | bool }}"
        force_deploy: "{{ options.force_deploy | default(lookup('env', 'FORCE_DEPLOY') | default('false', true)) | bool }}"
        remote_build: "{{ config.options.remote_build | default(false) | bool }}"
        sanitized_branch_name: "{{ branch_name | default(lookup('env', 'BRANCH_NAME')) | regex_replace('[^a-zA-Z0-9-]', '_') }}"
        stack_name: "{{ config.project_name }}-{{ env | default(lookup('env', 'ENV')) }}"
        # Deployment targets
        deploy_app: "{{ options.deploy_app | default(lookup('env', 'DEPLOY_APP') | default('true', true)) | bool }}"
        force_accessories: "{{ options.force_accessories | default(lookup('env', 'FORCE_ACCESSORIES') | default('false', true)) | bool }}"
        skip_accessories: "{{ options.skip_accessories | default(lookup('env', 'SKIP_ACCESSORIES') | default('false', true)) | bool }}"
        skip_docker_install: "{{ options.skip_docker_install | default(lookup('env', 'SKIP_DOCKER_INSTALL') | default('false', true)) | bool }}"

    - name: Set derived variables
      set_fact:
        services_option: "{{ ('--services=' + deploy_services) if deploy_services else '' }}"

    - name: Display template context info (debug mode only)
      debug:
        msg: |
          Template context loaded:
            - Current server: {{ current.name | default('N/A') }} ({{ current.host | default('N/A') }})
            - Servers in environment: {{ servers.keys() | list | join(', ') if servers is defined else 'N/A' }}
            - Cluster size: {{ cluster.size | default('N/A') }} ({{ cluster.manager_count | default(0) }} managers, {{ cluster.worker_count | default(0) }} workers)
      when: config.options.enable_debug_logs | default(false) | bool
      run_once: true
      delegate_to: localhost

    - name: Prepare deployment (render Docker templates)
      import_role:
        name: prepare-deployment
      run_once: true
      delegate_to: localhost

    - name: Display deployment targets
      debug:
        msg: |
          Deployment targets:
            - App: {{ deploy_app }}
            - Accessories: {{ 'skipped' if skip_accessories else ('forced' if force_accessories else 'auto (hash-check)') }}

    - name: Ensure dockflow directories exist
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ dockflow_paths.base }}"
        - "{{ dockflow_paths.stacks }}"
        - "{{ dockflow_paths.accessories }}"
        - "{{ dockflow_paths.audit }}"
        - "{{ dockflow_paths.metrics }}"
      loop_control:
        label: "{{ item }}"

    - name: Ensure locks directory exists with open permissions
      file:
        path: "{{ dockflow_paths.locks }}"
        state: directory
        mode: '1777'

    - name: Record deployment start time
      set_fact:
        deploy_start_time: "{{ ansible_facts['date_time']['epoch'] }}"

    - name: Acquire deploy lock
      include_role:
        name: deploy-lock
        tasks_from: acquire

  roles:
    - role: geerlingguy.docker
      when: not (skip_docker_install | default(false) | bool)
    - role: nginx
      tags:
        - nginx
    - role: private_ssh_keys
    - role: services
    # Pre-build hook (runs locally in CI) - only when deploying app
    - role: hooks
      vars:
        hook_name: "pre-build"
        hook_delegate: "localhost"
        hook_working_dir: "{{ root_path }}"
      delegate_to: localhost
      run_once: true
      when: deploy_app | bool
    - role: local-build
      when: 
        - deploy_app | bool
        - not (remote_build | bool)
      delegate_to: localhost
      run_once: true
    - role: remote-build
      when: 
        - deploy_app | bool
        - remote_build | bool
    # Post-build hook (runs locally in CI) - only when deploying app
    - role: hooks
      vars:
        hook_name: "post-build"
        hook_delegate: "localhost"
        hook_working_dir: "{{ root_path }}"
      delegate_to: localhost
      run_once: true
      when: deploy_app | bool

  tasks:
    # ============================================
    # ACCESSORIES DEPLOYMENT (Stateful services)
    # ============================================
    # Hash-based change detection:
    # - Always checks if accessories.yml changed (unless --skip-accessories)
    # - Only deploys if hash changed or first deployment
    # - --accessories flag forces redeploy (bypasses hash check)
    # IMPORTANT: Deployed BEFORE the app so databases/caches are ready
    
    - name: Check and deploy accessories if needed
      include_role:
        name: accessories
      when: not (skip_accessories | bool)

    # ============================================
    # APPLICATION DEPLOYMENT
    # ============================================
    
    # Pre-deploy hook (runs on remote server) - only when deploying app
    - name: Run pre-deploy hook
      include_role:
        name: hooks
      vars:
        hook_name: "pre-deploy"
        hook_delegate: "{{ inventory_hostname }}"
        hook_working_dir: "{{ stack_dir }}"
      when: deploy_app | bool

    - name: Deploy application using Docker Swarm
      include_role:
        name: docker-swarm
      vars:
        compose_path: "{{ root_path }}/.dockflow/docker/docker-compose.yml"
      when: deploy_app | bool

  post_tasks:
    # ============================================
    # APP POST-DEPLOYMENT TASKS
    # ============================================
    
    - name: Wait for Swarm internal healthchecks to complete
      include_role:
        name: swarm-healthcheck
      when: 
        - deploy_app | bool
        - config.health_checks.enabled | default(true) | bool

    - name: Run external health checks
      include_role:
        name: health-check
      vars:
        health_checks_config: "{{ config.health_checks | default({}) }}"
      when: 
        - deploy_app | bool
        - config.health_checks is defined
        - config.health_checks.enabled | default(true) | bool

    - name: Cleanup old stacks
      include_role:
        name: stack-management
        tasks_from: cleanup
      when: 
        - deploy_app | bool
        - (failed_health_checks | default([]) | length) == 0

    # Post-deploy hook (runs on remote server after successful deployment)
    - name: Run post-deploy hook
      include_role:
        name: hooks
      vars:
        hook_name: "post-deploy"
        hook_delegate: "{{ inventory_hostname }}"
        hook_working_dir: "{{ stack_dir }}"
      when: 
        - deploy_app | bool
        - (failed_health_checks | default([]) | length) == 0

    # ============================================
    # COMMON POST-DEPLOYMENT TASKS
    # ============================================

    # Write audit log entry
    - name: Record successful deployment in audit log
      include_role:
        name: audit-log
      vars:
        audit_result: "deployed"
        audit_message: >-
          {{ 'app' if deploy_app else '' }}{{ ' + ' if (deploy_app and force_accessories) else '' }}{{ 'accessories' if force_accessories else '' }}
          - {{ (failed_health_checks | default([]) | length) == 0 | ternary('success', 'with warnings') }}

    # Record deployment metrics
    - name: Record deployment metrics
      include_role:
        name: metrics
      vars:
        metric_status: "{{ 'success' if (failed_health_checks | default([]) | length) == 0 else 'failed' }}"
        metric_error: "{{ failed_health_checks | default([]) | join(', ') }}"

    # Release deploy lock (always, even on failure)
    - name: Release deploy lock
      include_role:
        name: deploy-lock
        tasks_from: release