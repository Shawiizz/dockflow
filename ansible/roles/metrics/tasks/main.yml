---
# Metrics role - records deployment metrics in JSONL format

- name: Set metrics paths
  set_fact:
    metrics_file: "{{ dockflow_paths.metrics }}/{{ stack_name }}/deployments.json"

- name: Ensure metrics directory exists
  file:
    path: "{{ dockflow_paths.metrics }}/{{ stack_name }}"
    state: directory
    mode: '0755'

- name: Calculate deployment duration
  set_fact:
    deploy_duration_ms: "{{ ((ansible_date_time.epoch | int) - (deploy_start_time | default(ansible_date_time.epoch) | int)) * 1000 }}"

- name: Build metric entry
  set_fact:
    metric_entry:
      id: "{{ ansible_date_time.epoch }}-{{ 999999999 | random | string | truncate(6, True, '') }}"
      timestamp: "{{ ansible_date_time.iso8601 }}"
      version: "{{ version | default(lookup('env', 'VERSION') | default('unknown', true)) }}"
      environment: "{{ env | default(lookup('env', 'ENV') | default('unknown', true)) }}"
      branch: "{{ branch_name | default(lookup('env', 'BRANCH_NAME') | default('unknown', true)) }}"
      status: "{{ metric_status | default('success') }}"
      duration_ms: "{{ deploy_duration_ms | int }}"
      performer: "{{ lookup('env', 'USER') | default('ci', true) }}@{{ lookup('env', 'HOSTNAME') | default('unknown', true) }}"
      services: "{{ deploy_services.split(',') | select() | list if deploy_services else [] }}"
      error: "{{ metric_error | default('') }}"
      rollback_from: "{{ rollback_from_version | default('') }}"
      build_skipped: "{{ skip_build | default(false) | bool }}"
      accessories_deployed: "{{ force_accessories | default(false) | bool }}"
      node_count: "{{ (groups['all'] | default([inventory_hostname])) | length }}"

- name: Write metric entry to JSONL file
  lineinfile:
    path: "{{ metrics_file }}"
    line: "{{ metric_entry | to_json }}"
    create: yes
    mode: '0644'

- name: Display metric summary
  debug:
    msg: "Metric recorded: {{ metric_entry.status }} in {{ deploy_duration_ms }}ms"
