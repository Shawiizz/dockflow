---
# Local build role - builds Docker images locally in CI/CD
# This role runs on localhost (CI/CD runner) before transferring images via local registry

- name: Generate build commands using decomposerize
  shell: |
    cd {{ root_path }}/.deployment/docker
    decomposerize docker-compose.yml --docker-build {{ services_option }} {{ environmentize_option }} --ansible-env-vars-format > /tmp/decomposerize_build.j2
  delegate_to: localhost
  changed_when: false

- name: Render build template with evaluated variables
  template:
    src: /tmp/decomposerize_build.j2
    dest: /tmp/decomposerize_build_rendered.sh
  delegate_to: localhost
  changed_when: false

- name: Get rendered build commands
  slurp:
    src: /tmp/decomposerize_build_rendered.sh
  delegate_to: localhost
  register: rendered_build_script
  changed_when: false

- name: Set evaluated build commands
  set_fact:
    build_commands: >-
      {{
        rendered_build_script.content
        | b64decode
        | split('\n')
        | map('trim')
        | select('truthy')
        | list
      }}

- name: Display build information
  debug:
    msg: "Building {{ build_commands | length }} Docker image(s) locally for host {{ hostname | default('main') }}"
  delegate_to: localhost

- name: Build Docker images locally (parallel)
  shell: |
    cd {{ root_path }}/.deployment/docker
    set -e
    PIDS=""
    {% for cmd in build_commands %}
    echo "Starting build: {{ cmd | regex_replace('.*-t\\s+\"?([^\"\\s]+)\"?.*', '\\1') }}"
    ( {{ cmd }} ) &
    PIDS="$PIDS $!"
    {% endfor %}
    # Wait for all builds and capture exit codes
    FAILED=0
    for PID in $PIDS; do
      if ! wait $PID; then
        FAILED=1
      fi
    done
    exit $FAILED
  delegate_to: localhost
  register: build_results
  when: build_commands is defined and build_commands | length > 0

- name: Display build completion
  debug:
    msg: "Successfully built {{ build_commands | length }} image(s) in parallel"
  delegate_to: localhost

- name: Display build validation completion
  debug:
    msg: "Successfully validated {{ build_commands | length }} Docker image(s) build"
  delegate_to: localhost
  when: env == 'build'

# Push images to registry if configured (external registry)
- name: Push images to registry
  include_role:
    name: docker-registry
  vars:
    built_images: "{{ build_commands | select('search', '-t\\s+') | map('regex_replace', '.*-t\\s+\"?([^\"\\s]+)\"?.*', '\\1') | list }}"
  when:
    - deployment_config.registry is defined
    - deployment_config.registry.enabled | default(false) | bool
    - not (build_mode | default(false) | bool)

# Use local registry for image transfer when no external registry is configured
- name: Transfer images via local registry
  include_role:
    name: local-registry
  vars:
    built_images: "{{ build_commands | select('search', '-t\\s+') | map('regex_replace', '.*-t\\s+\"?([^\"\\s]+)\"?.*', '\\1') | list }}"
  when:
    - not (deployment_config.registry.enabled | default(false) | bool)
    - not (build_mode | default(false) | bool)
