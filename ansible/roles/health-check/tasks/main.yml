---
# External Health Check role - performs HTTP health checks on deployed services
# This runs after Swarm internal healthchecks have passed
# Acts as a double-check to ensure services are truly accessible

- name: Initialize health checks configuration
  set_fact:
    health_checks_enabled: "{{ health_checks_config.enabled | default(true) | bool }}"
    health_check_endpoints: "{{ health_checks_config.endpoints | default([]) }}"
    health_check_on_failure: "{{ health_checks_config.on_failure | default('notify') }}"
  when: health_checks_config is defined

- name: Display health checks configuration
  debug:
    msg: "External health checks enabled: {{ health_checks_enabled | default(false) }}, On failure action: {{ health_check_on_failure | default('notify') }}"

- name: Skip external health checks if no endpoints configured
  debug:
    msg: "No external health check endpoints configured - skipping"
  when: health_check_endpoints | default([]) | length == 0

- name: Run external health checks
  block:
    - name: Wait for services to be ready
      pause:
        seconds: "{{ health_checks_config.startup_delay | default(health_check_startup_delay) }}"

    - name: Perform health checks on endpoints
      uri:
        url: "{{ item.url }}"
        method: "{{ item.method | default('GET') }}"
        status_code: "{{ item.expected_status | default(200) }}"
        timeout: "{{ item.timeout | default(health_check_default_timeout) }}"
        validate_certs: "{{ item.validate_certs | default(true) }}"
        return_content: yes
      register: health_check_results
      loop: "{{ health_check_endpoints }}"
      ignore_errors: true
      retries: "{{ item.retries | default(health_check_default_retries) }}"
      delay: "{{ item.retry_delay | default(health_check_default_retry_delay) }}"
      loop_control:
        label: "{{ item.name | default(item.url) }}"

    - name: Display health check results
      debug:
        msg: |
          Health Check: {{ item.item.name | default(item.item.url) }}
          Status: {{ 'PASSED' if not item.failed else 'FAILED' }}
          {% if item.status is defined %}Code: {{ item.status }}{% endif %}
          {% if item.elapsed is defined %}Time: {{ item.elapsed }}s{% endif %}
      loop: "{{ health_check_results.results | default([]) }}"
      loop_control:
        label: "{{ item.item.name | default(item.item.url) }}"

    - name: Check for failed health checks
      set_fact:
        failed_health_checks: "{{ health_check_results.results | selectattr('failed', 'equalto', true) | list }}"

    - name: Display summary of failed checks
      debug:
        msg: |
          HEALTH CHECK FAILURES DETECTED
          Failed endpoints:
          {% for check in failed_health_checks %}
          - {{ check.item.name | default(check.item.url) }}: {{ check.msg | default('Connection failed') }}
          {% endfor %}
      when: failed_health_checks | length > 0

    - name: Fail deployment if on_failure is 'fail'
      fail:
        msg: |
          Deployment failed: {{ failed_health_checks | length }}/{{ health_check_endpoints | length }} external health checks failed.
          
          Failed endpoints:
          {% for check in failed_health_checks %}
          - {{ check.item.name | default(check.item.url) }}
          {% endfor %}
      when:
        - failed_health_checks | length > 0
        - health_check_on_failure == 'fail'

    - name: Trigger rollback if on_failure is 'rollback'
      include_role:
        name: rollback
      when:
        - failed_health_checks | length > 0
        - health_check_on_failure == 'rollback'

    - name: Display notification on failure (continue deployment)
      debug:
        msg: |
          Health checks failed - deployment continues (on_failure: {{ health_check_on_failure }})
          Failed: {% for check in failed_health_checks %}{{ check.item.name | default(check.item.url) }}{% if not loop.last %}, {% endif %}{% endfor %}
      when:
        - failed_health_checks | length > 0
        - health_check_on_failure == 'notify'

    - name: Display success message
      debug:
        msg: "All external health checks passed ({{ health_check_endpoints | length }}/{{ health_check_endpoints | length }})"
      when: (failed_health_checks | default([]) | length) == 0

  when: 
    - health_checks_enabled | default(false)
    - health_check_endpoints | length > 0
