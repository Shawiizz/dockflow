---
# Hooks role - executes user-defined scripts at key deployment stages
# Hooks are optional shell scripts in .dockflow/hooks/
# Note: Hooks are pre-rendered by prepare-deployment role

- name: Set hooks configuration
  set_fact:
    hooks_enabled: "{{ config.hooks.enabled | default(true) | bool }}"
    hooks_timeout: "{{ config.hooks.timeout | default(300) }}"
    hooks_dir: "{{ root_path }}/.dockflow/hooks"
    hook_script_path: "{{ root_path }}/.dockflow/hooks/{{ hook_name }}.sh"

- name: Check if hook file exists
  stat:
    path: "{{ hook_script_path }}"
  register: hook_file
  delegate_to: localhost
  when: hooks_enabled

- name: Execute hook
  block:
    - name: Run hook script locally
      shell: |
        cd {{ hook_working_dir | default(root_path) }}
        timeout {{ hooks_timeout }} {{ hook_script_path }}
      args:
        executable: /bin/bash
      register: local_hook_result
      delegate_to: localhost
      when: hook_delegate | default('localhost') == 'localhost'

    - name: Copy and run hook script on remote
      block:
        - name: Create remote temp directory
          tempfile:
            state: directory
            prefix: "dockflow_hook_"
          register: remote_temp_dir

        - name: Copy hook script to remote
          copy:
            src: "{{ hook_script_path }}"
            dest: "{{ remote_temp_dir.path }}/{{ hook_name }}.sh"
            mode: '0755'

        - name: Run hook script on remote
          shell: |
            cd {{ hook_working_dir | default('/tmp') }}
            timeout {{ hooks_timeout }} {{ remote_temp_dir.path }}/{{ hook_name }}.sh
          args:
            executable: /bin/bash
          register: remote_hook_result

        - name: Cleanup remote temp directory
          file:
            path: "{{ remote_temp_dir.path }}"
            state: absent
      when: hook_delegate | default('localhost') != 'localhost'

    - name: Set unified hook result
      set_fact:
        hook_result: "{{ local_hook_result if (local_hook_result is defined and local_hook_result.rc is defined) else remote_hook_result | default({}) }}"

    - name: Display hook output
      debug:
        msg: "{{ ['Hook ''' + hook_name + ''' completed successfully', 'Output:'] + (hook_result.stdout_lines | default([])) }}"
      when: 
        - hook_result is defined
        - hook_result.rc is defined
        - hook_result.rc == 0

  rescue:
    - name: Display hook warning on failure
      debug:
        msg: |
          WARNING: Hook '{{ hook_name }}' failed (continuing deployment)
          Error: {{ hook_result.stderr | default('Unknown error') }}

  always:
    - name: Cleanup remote temp directory
      file:
        path: "{{ remote_temp_dir.path }}"
        state: absent
      when: remote_temp_dir.path is defined
      failed_when: false

  when:
    - hooks_enabled
    - hook_file.stat.exists | default(false)

- name: Skip hook if not found
  debug:
    msg: "Hook '{{ hook_name }}' not found, skipping"
  when: hooks_enabled and not (hook_file.stat.exists | default(false))
