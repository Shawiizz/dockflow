---
# Stack management role - handles stack retention and cleanup
# This task cleans up old releases while keeping the configured number

- name: Set stacks directory path
  set_fact:
    stacks_dir: "/var/lib/dockflow/stacks/{{ stack_name }}"

- name: Get configuration for number of releases to keep
  set_fact:
    keep_releases: "{{ deployment_config.stack_management.keep_releases | default(3) | int }}"
  when: deployment_config.stack_management is defined

- name: Set default if not configured
  set_fact:
    keep_releases: 3
  when: keep_releases is not defined

- name: Find all release directories
  find:
    paths: "{{ stacks_dir }}"
    file_type: directory
    patterns: "[0-9]*"
  register: stack_releases

- name: Sort releases by version and determine which to remove
  set_fact:
    sorted_releases: >-
      {%- set releases_with_version = [] -%}
      {%- for release in stack_releases.files -%}
        {%- set ver = release.path | basename | int -%}
        {%- set _ = releases_with_version.append({'path': release.path, 'version': ver}) -%}
      {%- endfor -%}
      {{ releases_with_version | sort(attribute='version', reverse=true) }}

- name: Determine releases to keep and remove
  set_fact:
    releases_to_keep: "{{ sorted_releases[:keep_releases | int] }}"
    releases_to_remove: "{{ sorted_releases[keep_releases | int:] }}"

- name: Display stack management plan
  debug:
    msg: |
      Stack Management Configuration:
      - Keep releases: {{ keep_releases }}
      - Total releases: {{ sorted_releases | length }}
      - Releases to keep: {{ releases_to_keep | map(attribute='version') | list }}
      - Releases to remove: {{ releases_to_remove | map(attribute='version') | list }}
  when: not global_no_log | default(false)

- name: Extract images from releases to remove
  block:
    - name: Read metadata from releases to remove
      slurp:
        src: "{{ item.path }}/metadata.json"
      register: removed_metadata
      loop: "{{ releases_to_remove }}"
      failed_when: false
      loop_control:
        label: "{{ item.path | basename }}"

    - name: Read docker-compose from releases to remove
      slurp:
        src: "{{ item.path }}/docker-compose.yml"
      register: removed_compose
      loop: "{{ releases_to_remove }}"
      failed_when: false
      loop_control:
        label: "{{ item.path | basename }}"

    - name: Extract image names from removed releases
      set_fact:
        images_from_removed_releases: >-
          {%- set images = [] -%}
          {%- for result in removed_compose.results -%}
            {%- if result.content is defined -%}
              {%- set compose = result.content | b64decode | from_yaml -%}
              {%- for svc_name, svc_config in compose.services.items() -%}
                {%- if svc_config.image is defined -%}
                  {%- set _ = images.append(svc_config.image) -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
          {%- endfor -%}
          {{ images | unique }}
      when: removed_compose.results is defined

  when: releases_to_remove | length > 0

- name: Build list of protected images from releases to keep
  block:
    - name: Read docker-compose from releases to keep
      slurp:
        src: "{{ item.path }}/docker-compose.yml"
      register: kept_compose
      loop: "{{ releases_to_keep }}"
      failed_when: false
      loop_control:
        label: "{{ item.path | basename }}"

    - name: Extract image names from kept releases
      set_fact:
        protected_images: >-
          {%- set images = [] -%}
          {%- for result in kept_compose.results -%}
            {%- if result.content is defined -%}
              {%- set compose = result.content | b64decode | from_yaml -%}
              {%- for svc_name, svc_config in compose.services.items() -%}
                {%- if svc_config.image is defined -%}
                  {%- set _ = images.append(svc_config.image) -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
          {%- endfor -%}
          {{ images | unique }}
      when: kept_compose.results is defined

- name: Set empty lists if not defined
  set_fact:
    images_from_removed_releases: []
    protected_images: []
  when: images_from_removed_releases is not defined or protected_images is not defined

- name: Determine images to delete
  set_fact:
    images_to_delete: "{{ images_from_removed_releases | default([]) | reject('in', protected_images | default([])) | reject('search', ':latest$') | list }}"

- name: Display cleanup plan
  debug:
    msg: |
      Cleanup Plan:
      - Protected images: {{ protected_images | length }}
      - Images from removed releases: {{ images_from_removed_releases | default([]) | length }}
      - Images to delete: {{ images_to_delete | length }}
      {% if images_to_delete | length > 0 %}
      
      Images to delete:
      {% for image in images_to_delete %}
      - {{ image }}
      {% endfor %}
      {% endif %}
  when: not global_no_log | default(false)

- name: Delete old images
  shell: "docker rmi {{ item }} 2>/dev/null || true"
  loop: "{{ images_to_delete }}"
  when: images_to_delete | length > 0
  failed_when: false
  loop_control:
    label: "Removing {{ item }}"

- name: Remove old release directories
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ releases_to_remove }}"
  when: releases_to_remove | length > 0
  loop_control:
    label: "{{ item.path | basename }}"

- name: Display cleanup summary
  debug:
    msg: |
      Cleanup Summary:
      - Removed {{ releases_to_remove | length }} old stack releases
      - Deleted {{ images_to_delete | length }} unused images
      - Kept {{ releases_to_keep | length }} recent releases
  when: not global_no_log | default(false)
