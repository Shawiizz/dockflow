---
# Swarm Healthcheck role - waits for Swarm internal healthchecks to complete
# This role polls the container health status before external healthchecks run

- name: Wait for internal healthchecks to complete
  block:
    - name: Get list of services in the stack
      shell: |
        docker stack services {{ stack_name }} --format {% raw %}'{{.Name}}:{{.Image}}'{% endraw %}
      register: stack_services_raw
      changed_when: false

    - name: Parse services and their expected images
      set_fact:
        stack_services_with_images: >-
          {%- set services = [] -%}
          {%- for line in stack_services_raw.stdout_lines -%}
            {%- set parts = line.split(':') -%}
            {%- set svc_name = parts[0] -%}
            {%- set svc_image = parts[1:] | join(':') -%}
            {%- set _ = services.append({'name': svc_name, 'expected_image': svc_image}) -%}
          {%- endfor -%}
          {{ services }}

    - name: Copy healthcheck script to remote
      copy:
        src: check-health.sh
        dest: /tmp/check-health.sh
        mode: '0755'

    - name: Check container health status for each service
      command: /tmp/check-health.sh "{{ item.name }}" "{{ item.expected_image }}" "{{ deployment_config.swarm.healthcheck_timeout | default(120) }}"
      loop: "{{ stack_services_with_images }}"
      register: health_results
      failed_when: false
      changed_when: false
      loop_control:
        label: "Checking {{ item.name }} ({{ item.expected_image }})"

    - name: Check for rollback or unhealthy services
      set_fact:
        rollback_detected_services: "{{ health_results.results | selectattr('rc', 'defined') | selectattr('rc', 'eq', 2) | map(attribute='item') | map(attribute='name') | list }}"
        unhealthy_services: "{{ health_results.results | selectattr('rc', 'defined') | selectattr('rc', 'eq', 1) | map(attribute='item') | map(attribute='name') | list }}"
        healthy_services: "{{ health_results.results | selectattr('rc', 'defined') | selectattr('rc', 'eq', 0) | map(attribute='item') | map(attribute='name') | list }}"
      when: health_results.results is defined

    - name: Debug health results
      debug:
        msg: "Service {{ item.item.name }}: rc={{ item.rc }} stdout={{ item.stdout_lines | default([]) | last | default('none') }}"
      loop: "{{ health_results.results }}"
      loop_control:
        label: "{{ item.item.name }}"

    - name: Copy rollback healthcheck script to remote
      copy:
        src: check-rollback-health.sh
        dest: /tmp/check-rollback-health.sh
        mode: '0755'
      when: rollback_detected_services | default([]) | length > 0

    - name: Wait for rolled back services to become healthy
      command: /tmp/check-rollback-health.sh "{{ item }}" "60"
      loop: "{{ rollback_detected_services | default([]) }}"
      register: rollback_health_check
      failed_when: false
      changed_when: false
      when: rollback_detected_services | default([]) | length > 0
      loop_control:
        label: "Checking rollback health for {{ item }}"

    - name: Check if rollback resulted in healthy state
      set_fact:
        rollback_unhealthy: "{{ rollback_health_check.results | default([]) | selectattr('rc', 'defined') | selectattr('rc', 'ne', 0) | list | length > 0 }}"
      when: rollback_detected_services | default([]) | length > 0

    - name: Display healthcheck summary
      debug:
        msg: |
          Internal Healthcheck Summary:
          - Total services: {{ stack_services_with_images | length }}
          - Rollback detected: {{ rollback_detected_services | default([]) | length }}
          - Timeout/Unhealthy: {{ unhealthy_services | default([]) | length }}
          - Healthy: {{ (stack_services_with_images | length) - (rollback_detected_services | default([]) | length) - (unhealthy_services | default([]) | length) }}
          {% if rollback_detected_services | default([]) | length > 0 %}
          
          Services that rolled back:
          {% for svc in rollback_detected_services %}
          - {{ svc }}
          {% endfor %}
          {% endif %}
          {% if unhealthy_services | default([]) | length > 0 %}
          
          Unhealthy/timeout services:
          {% for svc in unhealthy_services %}
          - {{ svc }}
          {% endfor %}
          {% endif %}

    - name: Cleanup failed release directory on rollback
      file:
        path: "{{ current_release_path }}"
        state: absent
      when:
        - rollback_detected_services | default([]) | length > 0
        - current_release_path is defined

    - name: Update current symlink to previous working version on rollback
      shell: |
        # Find the most recent successful release (exclude the failed one)
        STACKS_DIR="{{ current_stacks_dir }}"
        FAILED_VERSION="{{ current_version }}"
        
        # Get all version directories sorted by timestamp from metadata
        LATEST_GOOD=""
        LATEST_TIMESTAMP=""
        
        for DIR in "$STACKS_DIR"/*/; do
          if [ -d "$DIR" ] && [ "$(basename $DIR)" != "current" ]; then
            VERSION=$(basename "$DIR")
            if [ "$VERSION" != "$FAILED_VERSION" ]; then
              if [ -f "$DIR/metadata.json" ]; then
                TIMESTAMP=$(cat "$DIR/metadata.json" | grep -o '"timestamp"[[:space:]]*:[[:space:]]*"[^"]*"' | cut -d'"' -f4)
                if [ -z "$LATEST_TIMESTAMP" ] || [ "$TIMESTAMP" \> "$LATEST_TIMESTAMP" ]; then
                  LATEST_TIMESTAMP="$TIMESTAMP"
                  LATEST_GOOD="$DIR"
                fi
              fi
            fi
          fi
        done
        
        if [ -n "$LATEST_GOOD" ]; then
          ln -sfn "$LATEST_GOOD" "$STACKS_DIR/current"
          echo "Updated current symlink to $(basename $LATEST_GOOD)"
        fi
      when:
        - rollback_detected_services | default([]) | length > 0
        - current_stacks_dir is defined
      changed_when: true
      failed_when: false

    - name: Fail if rollback was detected
      fail:
        msg: |
          DEPLOYMENT FAILED: Some services failed healthchecks and Swarm has rolled back to the previous version.
          
          Services that rolled back:
          {% for svc in rollback_detected_services %}
          - {{ svc }}
          {% endfor %}
          
          {% if rollback_unhealthy | default(false) %}
          WARNING: The rolled back version is also unhealthy! Manual intervention may be required.
          {% else %}
          The previous working version is now running and healthy.
          {% endif %}
          
          Check the logs to debug the issue:
            docker service logs <service_name>
      when:
        - rollback_detected_services | default([]) | length > 0

    - name: Cleanup failed release directory on unhealthy timeout
      file:
        path: "{{ current_release_path }}"
        state: absent
      when:
        - unhealthy_services | default([]) | length > 0
        - rollback_detected_services | default([]) | length == 0
        - current_release_path is defined

    - name: Fail if services are unhealthy or timed out
      fail:
        msg: |
          DEPLOYMENT FAILED: Some services failed to become healthy within the timeout period.
          
          Unhealthy services:
          {% for svc in unhealthy_services %}
          - {{ svc }}
          {% endfor %}
          
          Check the service logs for details:
            docker service logs <service_name>
      when:
        - unhealthy_services | default([]) | length > 0

    - name: Set internal healthcheck status
      set_fact:
        internal_healthchecks_passed: "{{ (rollback_detected_services | default([]) | length) == 0 and (unhealthy_services | default([]) | length) == 0 }}"

  when: deployment_config.health_checks.wait_for_internal | default(true) | bool
