---
# Shared role: Create external networks and volumes from a compose file
#
# Required variables:
#   - compose_file_path: Path to the compose file (e.g., docker-compose.yml, accessories.yml)
#   - resource_label: Label for logging (e.g., "app", "accessories")
#
# Optional variables:
#   - skip_networks: Skip network creation (default: false)
#   - skip_volumes: Skip volume creation (default: false)

- name: "{{ resource_label | default('resources') }} - Create external networks"
  block:
    - name: "{{ resource_label }} - Get external networks creation commands"
      shell: |
        cd {{ compose_file_path | dirname }}
        decomposerize {{ compose_file_path | basename }} --create-external-networks --swarm 2>/dev/null || true
      delegate_to: localhost
      register: network_commands
      changed_when: false

    - name: "{{ resource_label }} - Execute external networks creation"
      shell: "{{ item }}"
      loop: "{{ network_commands.stdout_lines | select('truthy') | list }}"
      when: network_commands.stdout_lines | length > 0
      changed_when: true
      failed_when: false
      loop_control:
        label: "Creating network"
  when: not (skip_networks | default(false) | bool)

- name: "{{ resource_label | default('resources') }} - Create external volumes"
  block:
    - name: "{{ resource_label }} - Get external volumes creation commands"
      shell: |
        cd {{ compose_file_path | dirname }}
        decomposerize {{ compose_file_path | basename }} --create-external-volumes 2>/dev/null || true
      delegate_to: localhost
      register: volume_commands
      changed_when: false

    - name: "{{ resource_label }} - Execute external volumes creation"
      shell: "{{ item }}"
      loop: "{{ volume_commands.stdout_lines | select('truthy') | list }}"
      when: volume_commands.stdout_lines | length > 0
      changed_when: true
      failed_when: false
      loop_control:
        label: "Creating volume"
  when: not (skip_volumes | default(false) | bool)
