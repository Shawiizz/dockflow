---
# Remote Build - Build Docker images on the target server instead of locally
#
# Flow:
# 1. Clone git repo to remote server
# 2. Build Docker images
# 3. Push to registry OR distribute to workers
# 4. Cleanup (always)

- name: Set temporary build directory path
  set_fact:
    tmp_build_dir: "/tmp/docker-build-{{ config.project_name }}-{{ env }}-{{ version }}"

- name: Ensure Git is installed
  apt:
    name: git
    state: present
    update_cache: yes
  become: yes

- name: Create temporary build directory
  file:
    path: "{{ tmp_build_dir }}"
    state: directory
    mode: '0755'

- name: Clean up old build directories (older than 1 day)
  shell: find /tmp -maxdepth 1 -name 'docker-build-*' -type d -mtime +1 -exec rm -rf {} + || true
  changed_when: false
  failed_when: false  # Non-critical: cleanup can fail if no old dirs exist

- name: Clean up Docker to free space
  community.docker.docker_prune:
    containers: true
    images: true
    images_filters:
      dangling: false
    networks: true
    builder_cache: true
  failed_when: false  # Non-critical: prune can fail on empty system
  # Note: volumes: false (default) - never prune volumes as they may contain persistent data

- name: Build and distribute images
  block:
    - name: Clone repository
      include_tasks: git-clone.yml

    - name: Build Docker images
      include_tasks: docker-build.yml

    - name: Push images to registry
      include_role:
        name: docker-registry
      when:
        - config.registry is defined
        - config.registry.enabled | default(false) | bool

    - name: Distribute images to workers (no registry)
      include_tasks: distribute-images.yml
      when:
        - not (config.registry.enabled | default(false) | bool)
        - built_images | default([]) | length > 0

  always:
    - name: Cleanup temporary build directory
      file:
        path: "{{ tmp_build_dir }}"
        state: absent
      failed_when: false
