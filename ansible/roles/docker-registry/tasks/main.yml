---
# Docker Registry role - handles registry authentication and image pushing
# This role runs after building images to push them to the configured registry

- name: Check if registry is enabled
  set_fact:
    registry_enabled: "{{ config.registry.enabled | default(false) | bool }}"
    registry_url: "{{ config.registry.url | default('') }}"
    registry_namespace: "{{ config.registry.namespace | default('') }}"
    registry_auth_method: "{{ config.registry.auth_method | default('basic') }}"
  when: config.registry is defined

- name: Display registry status
  debug:
    msg: "Registry push is {{ 'enabled' if registry_enabled else 'disabled' }}"
  when: registry_enabled is defined

- name: Process registry operations
  block:
    - name: Login to Docker registry
      include_tasks: ../../playbooks/docker_registry_login.yml
      vars:
        registry_config: "{{ config.registry }}"

    # Get images either from built_images variable or extract from build_commands
    - name: Extract image names from build commands (if not already provided)
      include_tasks: ../local-registry/tasks/extract_image_names.yml
      when:
        - built_images is not defined
        - build_commands is defined

    - name: Set images to push
      set_fact:
        images_to_push: "{{ built_images | default([]) }}"

    - name: Process each image for registry push
      include_tasks: push_image.yml
      loop: "{{ images_to_push }}"
      loop_control:
        loop_var: image_name
      when: images_to_push is defined and images_to_push | length > 0

    - name: Logout from Docker registry
      shell: docker logout {{ registry_url }}
      when: registry_login_success | default(false)
      failed_when: false  # Non-critical: logout can fail if not logged in

  when:
    - registry_enabled | bool
    - registry_url != ""
    - registry_namespace != ""

- name: Skip registry push
  debug:
    msg: "Skipping registry push - not configured or disabled"
  when: not (registry_enabled | default(false) | bool) or registry_url == "" or registry_namespace == ""
