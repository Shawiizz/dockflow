---
# Task file for pushing individual images to registry

- name: Parse image name and tag
  set_fact:
    image_base_name: "{{ (image_name.split(':')[0] | basename) if ':' in image_name else (image_name | basename) }}"
    image_tag: "{{ image_name.split(':')[1] if ':' in image_name else 'latest' }}"
    full_registry_path: "{{ registry_url }}/{{ registry_namespace }}"

- name: Prepare registry image name
  set_fact:
    registry_image_base: "{{ full_registry_path }}/{{ image_base_name }}"
    registry_image_full: "{{ full_registry_path }}/{{ image_base_name }}:{{ image_tag }}"

- name: Tag and push image to registry (main tag)
  community.docker.docker_image:
    name: "{{ image_name }}"
    repository: "{{ registry_image_full }}"
    push: true
    source: local
  retries: 3
  delay: 5

- name: Process additional tags
  block:
    - name: Build processed tag list
      set_fact:
        processed_additional_tags: "{{ processed_additional_tags | default([]) + [item | replace('{version}', version | default(image_tag)) | replace('{env}', env) | replace('{branch}', sanitized_branch_name | default('main')) | replace('{sha}', git_sha | default('unknown'))] }}"
      loop: "{{ config.registry.additional_tags | default([]) }}"
      when: config.registry.additional_tags is defined

    - name: Tag and push additional tags
      community.docker.docker_image:
        name: "{{ image_name }}"
        repository: "{{ registry_image_base }}:{{ item }}"
        push: true
        source: local
      loop: "{{ processed_additional_tags | default([]) }}"
      retries: 3
      delay: 5
      when: processed_additional_tags is defined and processed_additional_tags | length > 0

- name: Display push summary
  debug:
    msg: "âœ“ Successfully pushed {{ image_base_name }} to {{ full_registry_path }}"
