---
# Transfer Docker images to all Swarm nodes via SSH (docker save | ssh | docker load)

- name: Check if image transfer is needed
  set_fact:
    needs_image_transfer: >-
      {{ not (config.registry.enabled | default(false) | bool) and not (remote_build | default(false) | bool) }}

- name: Transfer images to all nodes
  block:
    - name: Extract image names from build commands
      include_tasks: extract_image_names.yml
      when: build_commands is defined

    - name: Build manager node info
      set_fact:
        manager_node:
          host: "{{ hostvars[inventory_hostname].ansible_host }}"
          user: "{{ hostvars[inventory_hostname].ansible_user | default('root') }}"
          port: "{{ hostvars[inventory_hostname].ansible_port | default(22) }}"
          key_file: "{{ hostvars[inventory_hostname].ansible_ssh_private_key_file | default('') }}"
          name: "manager"
      delegate_to: localhost

    - name: Build all nodes list (manager + workers)
      set_fact:
        all_nodes: "{{ [manager_node] + (workers | default([])) }}"
      delegate_to: localhost

    - name: Transfer images to all nodes
      include_tasks: transfer_to_node.yml
      vars:
        transfer_from_manager: false
      loop: "{{ all_nodes }}"
      loop_control:
        loop_var: node
        label: "{{ node.name | default(node.host) }}"

  rescue:
    - name: Image transfer failed
      fail:
        msg: |
          Failed to transfer Docker images to Swarm nodes.
          Check SSH connectivity and disk space on target nodes.

  when:
    - needs_image_transfer | bool
    - build_commands is defined
    - build_commands | length > 0
