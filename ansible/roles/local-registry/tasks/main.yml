---
# Local Registry role - transfers Docker images to remote server via SSH streaming
# Uses docker save | ssh | docker load - simple and reliable, no registry or tunnel needed

- name: Check if image transfer is needed
  set_fact:
    needs_image_transfer: >-
      {{
        not (deployment_config.registry.enabled | default(false) | bool)
        and not (remote_build | default(false) | bool)
      }}

- name: Transfer images to remote server
  block:
    - name: Get list of built images from build commands
      set_fact:
        built_images: "{{ build_commands | select('search', '-t\\s+') | map('regex_replace', '.*-t\\s+\"?([^\"\\s]+)\"?.*', '\\1') | list }}"
      delegate_to: localhost
      when: build_commands is defined

    - name: Display images to transfer
      debug:
        msg: "Images to transfer: {{ built_images | join(', ') }}"
      delegate_to: localhost
      when: built_images | length > 0

    - name: Get remote server SSH details
      set_fact:
        ssh_remote_host: "{{ ansible_host }}"
        ssh_remote_user: "{{ ansible_user | default('root') }}"
        ssh_remote_port: "{{ ansible_port | default(22) }}"
        ssh_key_file: "{{ ansible_ssh_private_key_file | default('') }}"
      delegate_to: localhost

    - name: Build SSH options
      set_fact:
        ssh_opts: >-
          -o StrictHostKeyChecking=no
          -o ConnectTimeout=30
          -o ServerAliveInterval=60
          {% if ssh_key_file != '' %}-i {{ ssh_key_file }}{% endif %}
          -p {{ ssh_remote_port }}
      delegate_to: localhost

    - name: Transfer images via SSH streaming
      shell: |
        echo "Transferring {{ item }}..."
        docker save "{{ item }}" | ssh {{ ssh_opts }} {{ ssh_remote_user }}@{{ ssh_remote_host }} "docker load"
      delegate_to: localhost
      loop: "{{ built_images | default([]) }}"
      register: transfer_results
      loop_control:
        label: "Transferring {{ item }}"

    - name: Display transfer completion
      debug:
        msg: "Successfully transferred {{ built_images | length }} image(s) to remote server"
      delegate_to: localhost

  when:
    - needs_image_transfer | bool
    - build_commands is defined
    - build_commands | length > 0
