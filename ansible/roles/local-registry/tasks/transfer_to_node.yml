---
# Transfer images to a single node via SSH streaming
# Called with:
#   - node: dict with host, user, port, key_file (optional), private_key (optional), name
#   - built_images: list of image names to transfer
#   - transfer_from_manager: if true, runs on manager (for remote-build); otherwise delegates to localhost

- name: "Set transfer context for {{ node.name | default(node.host) }}"
  set_fact:
    _from_localhost: "{{ not (transfer_from_manager | default(false) | bool) }}"
    _key_path: "{{ '~/.ssh' if not (transfer_from_manager | default(false) | bool) else '/tmp/.ssh_transfer' }}"
    _node_name: "{{ node.name | default(node.host) }}"

- name: "Ensure SSH directory exists for {{ _node_name }}"
  file:
    path: "{{ _key_path }}"
    state: directory
    mode: '0700'
  delegate_to: "{{ 'localhost' if _from_localhost else omit }}"

# Write private key to temp file if provided (for workers)
- name: "Write SSH key for {{ _node_name }}"
  copy:
    content: "{{ node.private_key }}"
    dest: "{{ _key_path }}/worker_{{ _node_name }}"
    mode: '0600'
  delegate_to: "{{ 'localhost' if _from_localhost else omit }}"
  when: node.private_key is defined

# Build SSH options once, with the correct key path
- name: "Build SSH options for {{ _node_name }}"
  set_fact:
    _ssh_key_opt: >-
      {% if node.private_key is defined %}-i {{ _key_path }}/worker_{{ _node_name }}
      {% elif node.key_file | default('') != '' %}-i {{ node.key_file }}{% endif %}
    node_ssh_opts: >-
      -o StrictHostKeyChecking=no
      -o UserKnownHostsFile=/dev/null
      -o ConnectTimeout=30
      -o ServerAliveInterval=60
      {{ _ssh_key_opt | trim }}
      -p {{ node.port | default(22) }}

- name: "Transfer images to {{ _node_name }}"
  shell: |
    set -e
    echo "Transferring {{ item }} to {{ _node_name }}..."
    docker save "{{ item }}" | gzip -1 | ssh {{ node_ssh_opts }} {{ node.user | default('root') }}@{{ node.host }} "gunzip | docker load"
    echo "✓ Transferred {{ item }}"
  delegate_to: "{{ 'localhost' if _from_localhost else omit }}"
  loop: "{{ built_images | default([]) }}"
  register: node_transfer_results
  loop_control:
    label: "{{ item }} → {{ _node_name }}"

- name: "Verify transfer succeeded for {{ _node_name }}"
  fail:
    msg: |
      Failed to transfer image(s) to {{ _node_name }}
      
      {% for result in node_transfer_results.results %}
      {% if result.rc != 0 %}
      Image: {{ result.item }}
      Error: {{ result.stderr | default('No error output') }}
      {% endif %}
      {% endfor %}
      
      Check SSH connectivity and disk space on the target node.
  when: node_transfer_results.results | selectattr('rc', 'defined') | selectattr('rc', 'ne', 0) | list | length > 0

- name: "Cleanup SSH key for {{ _node_name }}"
  file:
    path: "{{ _key_path }}/worker_{{ _node_name }}"
    state: absent
  delegate_to: "{{ 'localhost' if _from_localhost else omit }}"
  when: node.private_key is defined
