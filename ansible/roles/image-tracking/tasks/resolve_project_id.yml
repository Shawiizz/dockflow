---
# Resolve project_id automatically if not provided
# This task looks at existing tracking files to find a matching project_id
# based on the images being deployed, or generates a new random one

- name: Check if project_id needs to be resolved
  set_fact:
    needs_project_id_resolution: "{{ project_id is not defined or project_id == '' or project_id == 'auto' }}"

- name: Resolve project_id from existing tracking files
  block:
    - name: Ensure tracking directory exists for resolution
      file:
        path: /var/lib/dockflow/images
        state: directory
        mode: '0755'

    - name: Get all tracked image files for this environment and branch
      find:
        paths: /var/lib/dockflow/images
        patterns: "{{ env }}_*_{{ sanitized_branch_name }}_*.json"
      register: all_env_tracking_files

    - name: Read all tracking files content
      slurp:
        src: "{{ item.path }}"
      register: tracking_files_content
      loop: "{{ all_env_tracking_files.files | sort(attribute='mtime', reverse=true) }}"
      when: all_env_tracking_files.files | length > 0
      loop_control:
        label: "{{ item.path | basename }}"

    - name: Parse tracking files and extract project info
      set_fact:
        parsed_tracking_files: "{{ tracking_files_content.results | default([]) | selectattr('content', 'defined') | map(attribute='content') | map('b64decode') | map('from_json') | list }}"
      when: tracking_files_content.results is defined and tracking_files_content.results | length > 0

    - name: Set empty parsed_tracking_files if none found
      set_fact:
        parsed_tracking_files: []
      when: parsed_tracking_files is not defined

    - name: Get images to deploy from docker-compose using decomposerize
      shell: |
        OUTPUT=$(decomposerize {{ compose_path }} --docker-run --environmentize 2>&1)
        EVALUATED=$(eval echo "$OUTPUT")
        # Extract image name (last element of each line)
        echo "$EVALUATED" | awk '{print $NF}' | sort -u
      register: images_to_deploy_raw
      delegate_to: localhost
      changed_when: false
      ignore_errors: true

    - name: Set images to deploy list (base image names without tag for matching)
      set_fact:
        images_to_deploy_bases: "{{ images_to_deploy_raw.stdout_lines | default([]) | map('regex_replace', ':.*$', '') | map('trim') | select | list }}"

    - name: Find matching project_id from existing tracking files
      set_fact:
        resolved_project_id: "{{ item.project_id }}"
      loop: "{{ parsed_tracking_files | default([]) }}"
      when:
        - resolved_project_id is not defined
        - item.images is defined
        - item.images | length > 0
        - (item.images | map(attribute='name') | map('regex_replace', ':.*$', '') | list) | intersect(images_to_deploy_bases) | length > 0
      loop_control:
        label: "{{ item.project_id | default('unknown') }} - {{ item.version | default('unknown') }}"

    - name: Generate new random project_id if no match found
      set_fact:
        resolved_project_id: "{{ range(10000000, 99999999) | random }}"
      when: resolved_project_id is not defined

    - name: Set project_id to resolved value
      set_fact:
        project_id: "{{ resolved_project_id }}"

  when: needs_project_id_resolution | bool
