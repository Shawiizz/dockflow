---
- name: Ensure Docker Swarm is initialized for accessories
  import_role:
    name: swarm-cluster

- name: Set accessories variables
  set_fact:
    accessories_compose_path: "{{ root_path }}/.dockflow/docker/accessories.yml"
    accessories_stack_name: "{{ stack_name }}-accessories"
    accessories_dir: "{{ accessories_base_dir }}"
    accessories_hash_file: "{{ accessories_base_dir }}/.hash"
    force_accessories: "{{ force_accessories | default(false) | bool }}"

- name: Check if accessories.yml exists
  stat:
    path: "{{ accessories_compose_path }}"
  delegate_to: localhost
  register: accessories_file

- name: Skip if no accessories configured
  debug:
    msg: "No accessories.yml found, skipping accessories deployment"
  when: not accessories_file.stat.exists

- name: Check and deploy accessories if changed
  when: accessories_file.stat.exists
  block:
    - name: Ensure accessories directory exists on remote
      file:
        path: "{{ accessories_dir }}"
        state: directory
        mode: '0755'

    - name: Calculate hash of rendered accessories compose
      shell: sha256sum "{{ accessories_compose_path }}" | cut -d' ' -f1
      delegate_to: localhost
      register: new_accessories_hash
      changed_when: false

    - name: Get stored hash from server
      slurp:
        src: "{{ accessories_hash_file }}"
      register: stored_hash_content
      failed_when: false

    - name: Set stored hash value
      set_fact:
        stored_accessories_hash: "{{ (stored_hash_content.content | default('') | b64decode | trim) if stored_hash_content.content is defined else '' }}"

    - name: Determine if accessories need deployment
      set_fact:
        accessories_need_deploy: "{{ force_accessories or (new_accessories_hash.stdout != stored_accessories_hash) }}"
        accessories_reason: >-
          {%- if force_accessories -%}
            forced deployment
          {%- elif stored_accessories_hash == '' -%}
            first deployment
          {%- elif new_accessories_hash.stdout != stored_accessories_hash -%}
            accessories.yml changed
          {%- else -%}
            no changes
          {%- endif -%}

    - name: Display accessories deployment decision
      debug:
        msg: "Accessories: {{ 'DEPLOYING' if accessories_need_deploy else 'SKIPPING' }} ({{ accessories_reason | trim }})"

    # ============================================
    # DEPLOY ACCESSORIES (only if needed)
    - name: Deploy accessories stack
      when: accessories_need_deploy
      block:
        - name: Create external resources for accessories
          include_role:
            name: _shared/create-resources
          vars:
            compose_file_path: "{{ accessories_compose_path }}"
            resource_label: "accessories"

        - name: Read rendered accessories compose
          slurp:
            src: "{{ accessories_compose_path }}"
          delegate_to: localhost
          register: acc_compose_content

        - name: Inject deploy config for accessories services
          include_role:
            name: _shared/inject-deploy
          vars:
            compose_content_b64: "{{ acc_compose_content.content }}"
            inject_mode: "accessories"

        - name: Copy accessories compose to remote
          copy:
            content: "{{ injected_compose }}"
            dest: "{{ accessories_dir }}/docker-compose.yml"
            mode: '0644'

        - name: Pull images for accessories
          command: docker compose -f {{ accessories_dir }}/docker-compose.yml pull
          register: accessories_pull
          changed_when: "'Pull complete' in accessories_pull.stdout or 'Downloaded' in accessories_pull.stdout"
          failed_when: false

        - name: Deploy accessories stack to Swarm
          community.docker.docker_stack:
            name: "{{ accessories_stack_name }}"
            state: present
            compose:
              - "{{ accessories_dir }}/docker-compose.yml"
            with_registry_auth: true
            prune: true
          register: accessories_deploy

        - name: Wait for accessories services to be ready
          command: "docker stack services {{ accessories_stack_name }} --format \"{{ '{{' }}.Name{{ '}}' }}: {{ '{{' }}.Replicas{{ '}}' }}\""
          register: accessories_status
          until: "'0/' not in accessories_status.stdout"
          retries: "{{ dockflow_defaults.accessories_retries }}"
          delay: "{{ dockflow_defaults.accessories_retry_delay }}"
          changed_when: false

        - name: Fail if accessories services are not ready
          fail:
            msg: |
              Accessories services failed to start properly.
              Status: {{ accessories_status.stdout_lines | join(', ') }}
          when: "'0/' in accessories_status.stdout"

        - name: Save new hash to server
          copy:
            content: "{{ new_accessories_hash.stdout }}"
            dest: "{{ accessories_hash_file }}"
            mode: '0644'
