---
# Docker Swarm role - handles Docker Swarm stack deployment
# This role deploys services using docker stack when deploy section is present in docker-compose.yml

- name: Check if Swarm mode should be used
  block:
    - name: Check if docker-compose.yml has deploy section
      shell: |
        if [ -f "{{ compose_path }}" ]; then
          grep -q "^\s*deploy:" "{{ compose_path }}" && echo "true" || echo "false"
        else
          echo "false"
        fi
      delegate_to: localhost
      register: has_deploy_section
      changed_when: false

    - name: Set Swarm mode flag
      set_fact:
        use_swarm_mode: "{{ has_deploy_section.stdout | trim == 'true' }}"
        swarm_stack_name: "{{ deployment_config.swarm.stack_name | default(project_id + '-' + env) }}"

- name: Display deployment mode
  debug:
    msg: "Using {{ 'Docker Swarm' if use_swarm_mode else 'standard Docker' }} deployment mode"

- name: Deploy using Docker Swarm
  block:
    - name: Check if Docker Swarm is initialized
      shell: docker info --format '{{ '{{' }}.Swarm.LocalNodeState{{ '}}' }}'
      register: swarm_state
      changed_when: false
      failed_when: false

    - name: Initialize Docker Swarm if not already initialized
      shell: |
        if [ "{{ swarm_state.stdout | trim }}" != "active" ]; then
          docker swarm init --advertise-addr {{ ansible_default_ipv4.address | default(ansible_all_ipv4_addresses[0]) }}
          echo "Swarm initialized"
        else
          echo "Swarm already active"
        fi
      register: swarm_init
      changed_when: "'Swarm initialized' in swarm_init.stdout"

    - name: Create temporary directory for compose file
      file:
        path: /tmp/swarm-deploy-{{ project_id }}-{{ env }}
        state: directory
        mode: '0755'

    - name: Transfer rendered docker-compose.yml to remote server
      copy:
        src: "{{ compose_path }}"
        dest: "/tmp/swarm-deploy-{{ project_id }}-{{ env }}/docker-compose.yml"
        mode: '0644'

    - name: Transfer .env file if exists
      copy:
        src: "{{ root_path }}/.deployment/docker/.env"
        dest: "/tmp/swarm-deploy-{{ project_id }}-{{ env }}/.env"
        mode: '0644'
      failed_when: false
      ignore_errors: yes

    - name: Login to registry on remote server if configured
      shell: |
        echo "{{ deployment_config.registry.password | default(deployment_config.registry.token) }}" | \
        docker login {{ deployment_config.registry.url }} \
          --username "{{ deployment_config.registry.username | default('oauth2') }}" \
          --password-stdin
      when:
        - deployment_config.registry is defined
        - deployment_config.registry.enabled | default(false) | bool
        - deployment_config.registry.url is defined
      no_log: true
      register: swarm_registry_login

    - name: Deploy Docker stack
      shell: |
        cd /tmp/swarm-deploy-{{ project_id }}-{{ env }}
        
        # Export environment variables from .env file if it exists
        if [ -f .env ]; then
          set -a
          source .env
          set +a
        fi
        
        # Deploy the stack
        docker stack deploy \
          --compose-file docker-compose.yml \
          {% if deployment_config.swarm.prune_services | default(true) | bool %}--prune \{% endif %}
          {% if deployment_config.registry is defined and deployment_config.registry.enabled | default(false) | bool %}--with-registry-auth \{% endif %}
          {{ swarm_stack_name }}
        
        echo "Stack {{ swarm_stack_name }} deployed"
      register: stack_deploy
      changed_when: true

    - name: Wait for services to be running
      shell: |
        TIMEOUT={{ deployment_config.swarm.wait_timeout | default(300) }}
        ELAPSED=0
        INTERVAL=5
        
        echo "Waiting for services to be running (timeout: ${TIMEOUT}s)..."
        
        while [ $ELAPSED -lt $TIMEOUT ]; do
          # Get service states
          SERVICES=$(docker stack services {{ swarm_stack_name }} --format "{{ '{{' }}.Name{{ '}}' }}:{{ '{{' }}.Replicas{{ '}}' }}")
          
          ALL_RUNNING=true
          for SERVICE in $SERVICES; do
            NAME=$(echo $SERVICE | cut -d: -f1)
            REPLICAS=$(echo $SERVICE | cut -d: -f2)
            CURRENT=$(echo $REPLICAS | cut -d/ -f1)
            DESIRED=$(echo $REPLICAS | cut -d/ -f2)
            
            if [ "$CURRENT" != "$DESIRED" ]; then
              ALL_RUNNING=false
              echo "Service $NAME: $CURRENT/$DESIRED replicas running"
            else
              echo "Service $NAME: âœ“ $CURRENT/$DESIRED replicas running"
            fi
          done
          
          if [ "$ALL_RUNNING" = "true" ]; then
            echo "All services are running!"
            exit 0
          fi
          
          sleep $INTERVAL
          ELAPSED=$((ELAPSED + INTERVAL))
        done
        
        echo "Warning: Timeout reached, some services may not be fully running"
        exit 1
      when: deployment_config.swarm.wait_for_services | default(true) | bool
      register: wait_result
      failed_when: false
      changed_when: false

    - name: Display stack status
      shell: |
        echo "=== Stack Services ==="
        docker stack services {{ swarm_stack_name }}
        echo ""
        echo "=== Stack Tasks ==="
        docker stack ps {{ swarm_stack_name }} --no-trunc
      register: stack_status
      changed_when: false

    - name: Show stack deployment status
      debug:
        msg: "{{ stack_status.stdout_lines }}"

    - name: Store deployment info for rollback
      copy:
        content: |
          STACK_NAME={{ swarm_stack_name }}
          COMPOSE_FILE=/tmp/swarm-deploy-{{ project_id }}-{{ env }}/docker-compose.yml
          DEPLOYMENT_TIME={{ ansible_date_time.iso8601 }}
          DEPLOYMENT_MODE=swarm
        dest: /var/lib/dockflow/swarm_{{ project_id }}_{{ env }}.info
        mode: '0644'

    - name: Cleanup temporary files
      file:
        path: /tmp/swarm-deploy-{{ project_id }}-{{ env }}
        state: absent
      when: deployment_config.options.enable_debug_logs | default(false) | bool == false

  when: use_swarm_mode | bool

- name: Skip Swarm deployment
  debug:
    msg: "No 'deploy' section found in docker-compose.yml - using standard Docker deployment"
  when: not (use_swarm_mode | bool)
