---
# Prepare deployment role - renders all templates in .deployment/
# This role runs on localhost before the actual deployment
# Renders: docker/, hooks/, and custom templates from config.yml

- name: Check if .deployment directory exists
  stat:
    path: "{{ root_path }}/.deployment"
  delegate_to: localhost
  register: deployment_dir
  changed_when: false

- name: Find all files in .deployment directory to render
  find:
    paths: "{{ root_path }}/.deployment"
    file_type: file
    recurse: yes
  delegate_to: localhost
  register: deployment_files
  when: deployment_dir.stat.exists

- name: Render all templates in .deployment with Jinja2
  template:
    src: "{{ item.path }}"
    dest: "{{ item.path }}"
    mode: preserve
  loop: "{{ deployment_files.files | default([]) }}"
  delegate_to: localhost
  when: 
    - deployment_dir.stat.exists
    - deployment_files.files is defined
  loop_control:
    label: "{{ item.path | regex_replace('^.*\\.deployment/', '.deployment/') }}"

- name: Display rendering completion
  debug:
    msg: "✓ Rendered {{ deployment_files.matched | default(0) }} file(s) in .deployment/"
  when: deployment_dir.stat.exists

# Render custom template files defined in config.yml (outside .deployment/)
- name: Render custom template files
  template:
    src: "{{ root_path }}/{{ (item.src | default(item)) }}"
    dest: "{{ root_path }}/{{ (item.dest | default(item)) }}"
    mode: '0644'
  loop: "{{ config.templates | default([]) }}"
  delegate_to: localhost
  when: config.templates is defined and config.templates | length > 0
  loop_control:
    label: "{{ item.src | default(item) }}"

- name: Display custom templates rendering completion
  debug:
    msg: "✓ Rendered {{ config.templates | length }} custom template file(s)"
  when: config.templates is defined and config.templates | length > 0

# Update docker-compose.yml images with environment tag and optional registry prefix
- name: Update docker-compose.yml images
  block:
    - name: Check if docker-compose.yml exists
      stat:
        path: "{{ compose_path }}"
      register: compose_file
      delegate_to: localhost

    - name: Read docker-compose.yml content
      slurp:
        src: "{{ compose_path }}"
      register: compose_content
      delegate_to: localhost
      when: compose_file.stat.exists

    - name: Parse and update docker-compose.yml images
      set_fact:
        updated_compose: "{{ compose_content['content'] | b64decode | from_yaml | combine({'services': updated_services}, recursive=true) }}"
      vars:
        use_auto_tag: "{{ config.options.image_auto_tag | default(true) | bool }}"
        use_registry: "{{ config.registry.enabled | default(false) | bool }}"
        registry_prefix: "{{ config.registry.url | default('') }}/{{ config.registry.namespace | default('') }}"
        env_tag: "-{{ env }}:{{ version }}"
        updated_services: >-
          {%- set ns = namespace(services={}) -%}
          {%- for service_name, service_config in (compose_content['content'] | b64decode | from_yaml).services.items() -%}
            {%- set original_image = service_config.image | default('') -%}
            {%- if original_image -%}
              {%- set image_without_tag = original_image.split(':')[0] -%}
              {%- if use_auto_tag -%}
                {%- set new_image = image_without_tag + env_tag -%}
              {%- else -%}
                {%- set new_image = original_image -%}
              {%- endif -%}
              {%- if use_registry and not ('/' in image_without_tag and '.' in image_without_tag.split('/')[0]) -%}
                {%- set new_image = registry_prefix + '/' + new_image -%}
              {%- endif -%}
              {%- set _ = ns.services.update({service_name: service_config | combine({'image': new_image})}) -%}
            {%- else -%}
              {%- set _ = ns.services.update({service_name: service_config}) -%}
            {%- endif -%}
          {%- endfor -%}
          {{ ns.services }}
      delegate_to: localhost
      when: compose_file.stat.exists

    - name: Write updated docker-compose.yml
      copy:
        content: "{{ updated_compose | to_nice_yaml(indent=2, width=999) }}"
        dest: "{{ compose_path }}"
        mode: '0644'
      delegate_to: localhost
      when: compose_file.stat.exists

    - name: Display image update completion
      debug:
        msg: "✓ Updated docker-compose.yml images{{ ' with -' + env + ':' + version if (config.options.image_auto_tag | default(true)) else '' }}{{ ' and registry prefix' if (config.registry.enabled | default(false)) else '' }}"
      delegate_to: localhost

  when: compose_file is not defined or compose_file.stat.exists | default(true)
