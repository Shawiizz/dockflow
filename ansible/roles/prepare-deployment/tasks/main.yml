---
# Prepare deployment role - exports environment variables and renders Docker templates
# This role runs on localhost before the actual deployment

- name: Export environment variables to YAML file
  shell: |
    python3 << 'PYTHON_EOF'
    import os
    import yaml

    env_vars = {}
    for key, value in os.environ.items():
        if key and key not in ['_', 'OLDPWD']:
            # Convert to lowercase for consistency
            key_lower = key.lower()
            env_vars[key_lower] = value

    # Write as proper YAML with multiline support
    with open('/tmp/ansible_env_vars.yml', 'w') as f:
        yaml.dump(env_vars, f, default_flow_style=False, allow_unicode=True)
    PYTHON_EOF
  delegate_to: localhost
  changed_when: false

- name: Display environment export confirmation
  debug:
    msg: "Environment variables exported to /tmp/ansible_env_vars.yml"

- name: Check if docker directory exists
  stat:
    path: "{{ root_path }}/.deployment/docker"
  delegate_to: localhost
  register: docker_dir
  changed_when: false

- name: Find all files in docker directory to render
  find:
    paths: "{{ root_path }}/.deployment/docker"
    file_type: file
    recurse: yes
  delegate_to: localhost
  register: docker_files
  when: docker_dir.stat.exists

- name: Render Docker templates with Jinja2
  template:
    src: "{{ item.path }}"
    dest: "{{ item.path }}"
    mode: '0644'
  loop: "{{ docker_files.files | default([]) }}"
  delegate_to: localhost
  when: 
    - docker_dir.stat.exists
    - docker_files.files is defined
  loop_control:
    label: "{{ item.path | basename }}"

- name: Display rendering completion
  debug:
    msg: "âœ“ Rendered {{ docker_files.matched | default(0) }} file(s) in .deployment/docker/"
  when: docker_dir.stat.exists
