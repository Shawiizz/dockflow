---
# Playbook to build Docker images locally (used by build workflow)
- name: Build Docker Images Locally
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    tmp_dir: "/tmp"
    framework_version: "2.0.6"
    root_path: "{{ lookup('env', 'ROOT_PATH') }}"
    compose_path: "{{ root_path }}/.deployment/docker/docker-compose.yml"
    skip_hooks: "{{ lookup('env', 'SKIP_HOOKS') | default(false) | bool }}"
  
  pre_tasks:
    - name: Display Dockflow version
      debug:
        msg: "Dockflow v{{ framework_version }} - Build Mode"

  roles:
    - role: ../roles/load-config
    - role: ../roles/prepare-deployment
    # Pre-build hook (runs locally)
    - role: ../roles/hooks
      vars:
        hook_name: "pre-build"
        hook_delegate: "localhost"
        hook_working_dir: "{{ root_path }}"
      when: not (skip_hooks | default(false) | bool)
  
  tasks:
    - name: Set computed variables
      set_fact:
        global_no_log: "{{ not (config.options.enable_debug_logs | default(false) | bool) }}"
        deploy_services: "{{ lookup('env', 'DEPLOY_DOCKER_SERVICES') | default('', true) }}"
        services_option: "{{ ('--services=' + lookup('env', 'DEPLOY_DOCKER_SERVICES')) if lookup('env', 'DEPLOY_DOCKER_SERVICES') else '' }}"
        hostname: "main"

    - name: Build Docker images
      include_role:
        name: ../roles/local-build

    # Post-build hook (runs locally)
    - name: Run post-build hook
      include_role:
        name: ../roles/hooks
      vars:
        hook_name: "post-build"
        hook_delegate: "localhost"
        hook_working_dir: "{{ root_path }}"
      when: not (skip_hooks | default(false) | bool)
