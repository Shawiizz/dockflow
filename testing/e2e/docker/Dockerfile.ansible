FROM python:3.11-alpine

# Install system dependencies including Node.js
RUN apk add --no-cache \
    bash \
    git \
    openssh-client \
    sshpass \
    curl \
    jq \
    rsync \
    docker-cli \
    sudo \
    nodejs \
    npm \
    && rm -rf /var/cache/apk/*

# Install Ansible and dependencies
RUN pip install --no-cache-dir \
    ansible \
    ansible-core \
    pyyaml \
    jinja2

# Install decomposerize globally
RUN npm install -g shawiizz-decomposerize

# Install common Ansible collections
RUN ansible-galaxy collection install \
    community.docker \
    ansible.posix

# Install Ansible roles
RUN ansible-galaxy role install \
    geerlingguy.docker \
    geerlingguy.pip

# Set working directory
WORKDIR /workspace

# Default command
CMD ["/bin/bash"]