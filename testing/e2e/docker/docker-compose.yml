services:
  # Manager node - Swarm manager for E2E tests
  test-vm-manager:
    build:
      context: .
      dockerfile: Dockerfile.test-vm
      args:
        SSH_USER: ${SSH_USER}
        SSH_PASSWORD: ${SSH_PASSWORD}
    container_name: dockflow-test-manager
    hostname: dockflow-test-mgr
    privileged: true
    environment:
      - SSH_USER=${SSH_USER}
      - SSH_PASSWORD=${SSH_PASSWORD}
    ports:
      - "${SSH_PORT_MANAGER:-2222}:22"
      - "${DOCKER_PORT:-2375}:2375"
      - "8080:8080"
    volumes:
      - /tmp
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "22"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

  # Worker node - Swarm worker for E2E tests
  test-vm-worker-1:
    build:
      context: .
      dockerfile: Dockerfile.test-vm
      args:
        SSH_USER: ${SSH_USER}
        SSH_PASSWORD: ${SSH_PASSWORD}
    container_name: dockflow-test-worker-1
    hostname: dockflow-test-w1
    privileged: true
    environment:
      - SSH_USER=${SSH_USER}
      - SSH_PASSWORD=${SSH_PASSWORD}
    ports:
      - "${SSH_PORT_WORKER_1:-2223}:22"
    volumes:
      - /tmp
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "22"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

networks:
  test-network:
    driver: bridge
