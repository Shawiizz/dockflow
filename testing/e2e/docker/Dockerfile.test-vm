
# Utilise Ubuntu comme base pour compatibilité apt/Ansible
FROM ubuntu:22.04

# Arguments de build
ARG SSH_USER=deploy
ARG SSH_PASSWORD=deploy123

# Empêche les prompts interactifs
ENV DEBIAN_FRONTEND=noninteractive

# Met à jour le système et installe les dépendances nécessaires
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get install -y --no-install-recommends \
        openssh-server \
        sudo \
        bash \
        curl \
        git \
        python3 \
        python3-pip \
        python3-apt \
        jq \
        rsync \
        netcat-openbsd \
        nginx \
        docker.io \
    && pip3 install --no-cache-dir pyyaml \
    && rm -rf /var/lib/apt/lists/*

# Configure SSH
RUN mkdir -p /var/run/sshd && \
    sed -i 's/#PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config && \
    sed -i 's/#PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config && \
    sed -i 's/#PubkeyAuthentication.*/PubkeyAuthentication yes/' /etc/ssh/sshd_config && \
    sed -i 's/#Port 22/Port 22/' /etc/ssh/sshd_config

# Crée l'utilisateur deploy avec sudo
RUN useradd -m -s /bin/bash ${SSH_USER} && \
    echo "${SSH_USER}:${SSH_PASSWORD}" | chpasswd && \
    echo "${SSH_USER} ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers && \
    mkdir -p /home/${SSH_USER}/.ssh && \
    chmod 700 /home/${SSH_USER}/.ssh && \
    chown -R ${SSH_USER}:${SSH_USER} /home/${SSH_USER}

# Ajoute l'utilisateur deploy au groupe docker
RUN usermod -aG docker ${SSH_USER}

# Crée les dossiers nécessaires
RUN mkdir -p /opt/docker-compose \
    /var/log/deployment \
    /home/${SSH_USER}/deployments && \
    chown -R ${SSH_USER}:${SSH_USER} /home/${SSH_USER}/deployments \
    /var/log/deployment

# Copie les scripts
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

COPY healthcheck.sh /healthcheck.sh
RUN chmod +x /healthcheck.sh

EXPOSE 22 2375 2376 80 443

HEALTHCHECK --interval=10s --timeout=5s --start-period=30s --retries=3 \
    CMD /healthcheck.sh

ENTRYPOINT ["/entrypoint.sh"]
