name: Deploy

on:
  workflow_call:
    inputs:
      tag:
        required: false
        type: string
        description: "The tag to deploy, e.g. 1.0.0 or 1.0.0-staging"
      version:
        required: false
        type: string
        description: "The version to deploy, e.g. 1.0.0"
      free-disk-space:
        required: false
        type: boolean
        default: false
        description: "Free disk space by removing unnecessary tools"

env:
  DOCKFLOW_REPOSITORY_URL: https://github.com/Shawiizz/dockflow.git
  DOCKFLOW_FRAMEWORK_VERSION: 1.0.52

jobs:
  discover-hosts:
    runs-on: ubuntu-latest
    name: Discover deployment hosts
    outputs:
      hosts: ${{ steps.discover.outputs.hosts }}
      env: ${{ steps.discover.outputs.env }}
      tag: ${{ steps.discover.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Discover hosts and environment
        id: discover
        run: |
          # Determine tag and environment
          TAG="${{ inputs.tag || inputs.version }}"
          if [ -z "$TAG" ]; then
            echo "::error::Either tag or version input must be provided"
            exit 1
          fi
          
          ENV="${TAG##*-}"
          [[ "$TAG" == "$ENV" ]] && ENV="production"
          
          echo "env=$ENV" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          
          # Clone dockflow framework
          git clone --depth 1 --branch "${{ env.DOCKFLOW_FRAMEWORK_VERSION }}" "${{ env.DOCKFLOW_REPOSITORY_URL }}" /tmp/dockflow
          chmod +x /tmp/dockflow/.common/scripts/*.sh
          
          # Discover hosts
          HOSTS_JSON=$(/tmp/dockflow/.common/scripts/discover_hosts.sh "$ENV")
          echo "hosts=$HOSTS_JSON" >> $GITHUB_OUTPUT
          echo "Discovered hosts: $HOSTS_JSON"

  deploy:
    runs-on: ubuntu-latest
    name: Deploy to ${{ needs.discover-hosts.outputs.env }} (${{ matrix.host }} host)
    needs: discover-hosts
    strategy:
      matrix:
        host: ${{ fromJson(needs.discover-hosts.outputs.hosts) }}
    steps:
      - name: Free Disk Space (Ubuntu)
        if: ${{ inputs.free-disk-space }}
        uses: jlumbroso/free-disk-space@main
        with:
          docker-images: false

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          npm i -g shawiizz-decomposerize
          sudo apt-get update && sudo apt-get install -y python3-pip
          pip3 install pyyaml

      - name: Clone dockflow repository
        run: git clone --depth 1 --branch "$DOCKFLOW_FRAMEWORK_VERSION" "$DOCKFLOW_REPOSITORY_URL" dockflow

      - name: Deploy to host ${{ matrix.host }}
        run: |
          echo '${{ toJSON(secrets) }}' > secrets.json
          
          export ENV="${{ needs.discover-hosts.outputs.env }}"
          export HOSTNAME="${{ matrix.host }}"
          export VERSION="${{ needs.discover-hosts.outputs.tag }}"
          export ANSIBLE_HOST_KEY_CHECKING=False
          export PROJECT_ID="${{ github.repository_id }}"
          export ROOT_PATH="$(pwd)"
          
          # Determine branch name
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            BRANCH_NAME=$(git branch -r --contains "${{ github.ref_name }}" | grep -v "HEAD" | head -n1 | sed 's/.*origin\///')
            BRANCH_NAME="${BRANCH_NAME:-$(git remote show origin | grep "HEAD branch" | cut -d ":" -f 2 | xargs)}"
          else
            BRANCH_NAME="${{ github.ref_name }}"
          fi
          export BRANCH_NAME
          
          source dockflow/.common/scripts/load_env.sh "$ENV" "$HOSTNAME"
          bash dockflow/.common/scripts/deploy_with_ansible.sh
