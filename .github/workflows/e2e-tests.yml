name: E2E Tests

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  e2e-tests:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Build CLI binary
        working-directory: cli-ts
        run: |
          bun install
          bun run build linux-x64

      - name: Start test environment
        working-directory: testing/e2e/docker
        run: |
          docker compose --env-file ../.env up -d --build
          echo "Waiting for services to be ready..."
          sleep 10

      - name: Wait for test VM to be healthy
        run: |
          timeout=60
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if docker ps | grep -q "healthy.*dockflow-test-vm"; then
              echo "✓ Test VM is healthy"
              exit 0
            fi
            sleep 2
            elapsed=$((elapsed + 2))
          done
          echo "ERROR: Test VM did not become healthy in time"
          docker compose -f testing/e2e/docker/docker-compose.yml logs test-vm
          exit 1

      - name: Run E2E Test Suite
        run: |
          bash testing/e2e/run-tests.sh

      - name: Verify application is deployed
        run: |
          echo "Verifying deployed application..."
          RESPONSE=$(docker exec dockflow-test-vm curl -sf http://localhost:8080/ 2>&1)
          if echo "$RESPONSE" | grep -q "DOCKFLOW_E2E_TEST_APP_DEPLOYED"; then
            echo "✓ Application is correctly deployed and accessible"
          else
            echo "ERROR: Application verification failed"
            echo "Response received:"
            echo "$RESPONSE"
            exit 1
          fi

      - name: Show test VM logs on failure
        if: failure()
        run: |
          echo "=== Test VM Logs ==="
          docker compose -f testing/e2e/docker/docker-compose.yml logs test-vm
          echo ""
          echo "=== Container logs inside test VM ==="
          docker exec dockflow-test-vm docker logs test-web-app-test 2>&1 || echo "Could not fetch app logs"

      - name: Cleanup
        if: always()
        working-directory: testing/e2e/docker
        run: |
          docker compose --env-file ../.env down -v
