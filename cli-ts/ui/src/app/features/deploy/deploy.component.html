<div class="deploy-page animate-fade-in">
  <!-- Page Header -->
  <div class="page-header">
    <div class="page-header__left">
      <h1 class="page-header__title">Deployments</h1>
      <p class="page-header__subtitle">Deploy your project and view history</p>
    </div>
    <div class="page-header__actions">
      <button class="btn btn--primary" (click)="showForm.set(!showForm())">
        <i class="pi" [class.pi-plus]="!showForm()" [class.pi-times]="showForm()"></i>
        <span>{{ showForm() ? 'Close' : 'New Deploy' }}</span>
      </button>
      <button class="btn btn--secondary" (click)="refresh()" [disabled]="loading()">
        <i class="pi pi-refresh" [class.pi-spin]="loading()"></i>
        <span>Refresh</span>
      </button>
    </div>
  </div>

  <!-- Deploy Form -->
  @if (showForm()) {
    <div class="card" style="padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem;">
      <h3 style="margin: 0; font-size: 1rem;">New Deployment</h3>
      <div class="flex flex-wrap gap-4">
        <div class="flex flex-col gap-1" style="min-width: 10rem;">
          <label class="text-sm text-muted">Version</label>
          <input type="text" class="p-inputtext p-component" [(ngModel)]="version" placeholder="latest" style="width: 100%;">
        </div>
        <div class="flex flex-col gap-1" style="min-width: 10rem;">
          <label class="text-sm text-muted">Services filter</label>
          <input type="text" class="p-inputtext p-component" [(ngModel)]="servicesFilter" placeholder="e.g. web,api" style="width: 100%;">
        </div>
      </div>
      <div class="flex flex-wrap gap-4">
        <label class="flex items-center gap-2"><input type="checkbox" [(ngModel)]="skipBuild"> Skip Build</label>
        <label class="flex items-center gap-2"><input type="checkbox" [(ngModel)]="force"> Force</label>
        <label class="flex items-center gap-2"><input type="checkbox" [(ngModel)]="deployAccessories"> Accessories</label>
        <label class="flex items-center gap-2"><input type="checkbox" [(ngModel)]="all"> All</label>
        <label class="flex items-center gap-2"><input type="checkbox" [(ngModel)]="skipAccessories"> Skip Accessories</label>
        <label class="flex items-center gap-2"><input type="checkbox" [(ngModel)]="dryRun"> Dry Run</label>
      </div>
      <div class="flex gap-2">
        <button class="btn btn--primary" (click)="startDeploy()" [disabled]="deploying() || !envService.selectedOrUndefined()">
          <i class="pi pi-upload"></i>
          <span>{{ deploying() ? 'Deploying...' : 'Deploy' }}</span>
        </button>
        @if (deploying()) {
          <button class="btn btn--danger" (click)="cancelDeploy()">
            <i class="pi pi-times"></i>
            <span>Cancel</span>
          </button>
        }
      </div>
    </div>
  }

  <!-- Deploy Console Output -->
  @if (deployLogs().length > 0) {
    <div class="card" style="padding: 0;">
      <div style="padding: 0.75rem 1rem; border-bottom: 1px solid var(--p-surface-200); display: flex; align-items: center; justify-content: space-between;">
        <span class="text-sm font-medium">Output</span>
        @if (deploySuccess() === true) {
          <p-tag value="Success" severity="success" [rounded]="true" />
        } @else if (deploySuccess() === false) {
          <p-tag value="Failed" severity="danger" [rounded]="true" />
        } @else if (deploying()) {
          <p-tag value="Running" severity="info" [rounded]="true" />
        }
      </div>
      <div style="background: #0a0a0a; color: #fafafa; font-family: 'JetBrains Mono', monospace; font-size: 0.8125rem; padding: 1rem; max-height: 25rem; overflow-y: auto; white-space: pre-wrap; word-break: break-all;">
        @for (line of deployLogs(); track $index) {
          <div>{{ line }}</div>
        }
      </div>
    </div>
  }

  <!-- Error -->
  @if (error()) {
    <div class="error-banner">
      <i class="pi pi-exclamation-triangle"></i>
      <span class="error-banner__text">{{ error() }}</span>
      <button class="btn btn--ghost btn--icon" (click)="refresh()">
        <i class="pi pi-refresh"></i>
      </button>
    </div>
  }

  <!-- Loading -->
  @if (loading()) {
    <div class="deploy-list">
      @for (i of [1, 2, 3]; track i) {
        <div class="card" style="padding: 1rem 1.25rem; display: flex; gap: 1rem; align-items: flex-start;">
          <p-skeleton shape="circle" size="2rem" />
          <div style="flex: 1; display: flex; flex-direction: column; gap: 0.5rem;">
            <div class="flex items-center justify-between">
              <p-skeleton width="40%" height="0.9375rem" />
              <p-skeleton width="3.5rem" height="1.375rem" borderRadius="9999px" />
            </div>
            <div class="flex gap-4">
              <p-skeleton width="4rem" height="0.625rem" />
              <p-skeleton width="3rem" height="0.625rem" />
              <p-skeleton width="3.5rem" height="0.625rem" />
            </div>
          </div>
        </div>
      }
    </div>
  } @else if (deployments().length === 0) {
    <div class="empty-state">
      <i class="pi pi-upload"></i>
      <h3>No deployments yet</h3>
      <p>Deploy your project to start recording history.</p>
    </div>
  } @else {
    <!-- Deployment History -->
    <div class="deploy-list">
      @for (deploy of deployments(); track deploy.id) {
        <div class="deploy-entry card card--hover">
          <div class="deploy-entry__status-col">
            <div class="deploy-entry__status-icon" [class]="'deploy-entry__status-icon--' + deploy.status">
              <i [class]="statusIcon(deploy.status)"></i>
            </div>
          </div>
          <div class="deploy-entry__content">
            <div class="deploy-entry__header">
              <div class="deploy-entry__title-row">
                <h3 class="deploy-entry__title">
                  {{ deploy.environment }}
                  <span class="deploy-entry__target">({{ deploy.target }})</span>
                </h3>
                <p-tag
                  [value]="deploy.status"
                  [severity]="statusSeverity(deploy.status)"
                  [rounded]="true"
                />
              </div>
              <div class="deploy-entry__meta">
                @if (deploy.version) {
                  <span class="deploy-entry__version">
                    <i class="pi pi-tag"></i> {{ deploy.version }}
                  </span>
                }
                <span class="deploy-entry__time" [pTooltip]="formatDate(deploy.startedAt)">
                  <i class="pi pi-clock"></i> {{ relativeTime(deploy.startedAt) }}
                </span>
                @if (deploy.duration) {
                  <span class="deploy-entry__duration">
                    <i class="pi pi-stopwatch"></i> {{ formatDuration(deploy.duration) }}
                  </span>
                }
                @if (deploy.user) {
                  <span class="deploy-entry__user">
                    <i class="pi pi-user"></i> {{ deploy.user }}
                  </span>
                }
              </div>
            </div>
            @if (deploy.error) {
              <div class="deploy-entry__error">
                <i class="pi pi-exclamation-triangle"></i>
                <span>{{ deploy.error }}</span>
              </div>
            }
          </div>
        </div>
      }
    </div>
  }
</div>
