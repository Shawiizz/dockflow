<div class="dashboard animate-fade-in">
  <!-- Error banner -->
  @if (errorMessage()) {
    <div class="error-banner">
      <i class="pi pi-exclamation-triangle"></i>
      <span class="error-banner__text">{{ errorMessage() }}</span>
      <button class="btn btn--ghost btn--icon" (click)="errorMessage.set(null)">
        <i class="pi pi-times"></i>
      </button>
    </div>
  }

  <!-- Welcome card if no project -->
  @if (!loadingProject() && projectInfo() && !projectInfo()!.hasDockflow) {
    <app-welcome-card />
  } @else {
    <!-- Stats Row -->
    <div class="dashboard__stats">
      <app-stats-card
        icon="pi pi-server"
        label="Total Servers"
        [value]="totalServers()"
        variant="info"
        [loading]="serverStatus.loading()"
      />
      <app-stats-card
        icon="pi pi-check-circle"
        label="Online"
        [value]="serverStatus.onlineCount()"
        variant="success"
        [loading]="serverStatus.loading()"
      />
      <app-stats-card
        icon="pi pi-times-circle"
        label="Offline"
        [value]="serverStatus.offlineCount()"
        variant="error"
        [loading]="serverStatus.loading()"
      />
      <app-stats-card
        icon="pi pi-globe"
        label="Environments"
        [value]="envCount()"
        variant="default"
        [loading]="serverStatus.loading()"
      />
    </div>

    <!-- Connection Warning -->
    @if (connectionInfo() && !connectionInfo()!.ready) {
      <div class="dashboard__warning card">
        <i class="pi pi-exclamation-triangle"></i>
        <div>
          <p><strong>No connection credentials</strong></p>
          <p>{{ connectionInfo()!.message }}</p>
          <a routerLink="/settings" class="btn btn--ghost" style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.8125rem">
            <i class="pi pi-cog"></i>
            <span>Go to Settings</span>
          </a>
        </div>
      </div>
    }

    <!-- Servers Grid -->
    <div class="dashboard__section">
      <div class="dashboard__section-header">
        <h2 class="dashboard__section-title">Servers</h2>
        @if (!serverStatus.loading()) {
          <button class="btn btn--ghost" (click)="serverStatus.checkAll()">
            <i class="pi pi-refresh"></i>
            <span>Check All</span>
          </button>
        }
      </div>

      @if (serverStatus.loading()) {
        <div class="dashboard__servers-grid">
          @for (i of [1, 2, 3, 4]; track i) {
            <div class="card" style="padding: 1rem; display: flex; flex-direction: column; gap: 0.75rem;">
              <div class="flex items-center gap-3">
                <p-skeleton shape="circle" size="2.25rem" />
                <div style="flex: 1;">
                  <p-skeleton width="60%" height="0.875rem" styleClass="mb-1" />
                  <p-skeleton width="40%" height="0.625rem" />
                </div>
              </div>
              <p-skeleton width="100%" height="2rem" />
            </div>
          }
        </div>
      } @else if (serverStatus.servers().length === 0) {
        <div class="empty-state">
          <i class="pi pi-server"></i>
          <h3>No servers configured</h3>
          <p>Add servers to your servers.yml configuration file.</p>
          <a routerLink="/settings" class="btn btn--primary" style="margin-top: 1rem">
            <i class="pi pi-cog"></i>
            <span>Go to Settings</span>
          </a>
        </div>
      } @else {
        <div class="dashboard__servers-grid">
          @for (server of serverStatus.servers(); track server.name) {
            <app-server-card
              [server]="server"
              [checkingStatus]="serverStatus.isChecking(server.name)"
              (checkStatus)="onCheckServer(server.name)"
              (sshOpen)="openSsh({ name: server.name, host: server.host })"
            />
          }
        </div>
      }
    </div>
  }

  <!-- SSH Terminal Dialog -->
  <app-ssh-terminal
    [serverName]="sshServerName()"
    [serverHost]="sshServerHost()"
    [visible]="sshVisible()"
    (visibleChange)="sshVisible.set($event)"
  />
</div>
