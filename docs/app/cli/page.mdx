# CLI Commands

import { Callout } from 'nextra/components'

Dockflow provides a comprehensive CLI for managing your deployments and interacting with running services.

## Installation

Install the Dockflow CLI using the installation script:

import { Tabs } from 'nextra/components'

<Tabs items={['Linux / macOS', 'Windows']}>
  <Tabs.Tab>
    ```bash
    curl -fsSL https://raw.githubusercontent.com/Shawiizz/dockflow/main/install.sh | bash
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```powershell
    irm https://raw.githubusercontent.com/Shawiizz/dockflow/main/install.ps1 | iex
    ```
  </Tabs.Tab>
</Tabs>

The script automatically detects your platform and architecture, downloads the appropriate binary, and adds it to your PATH.

<Callout type="info">
  The CLI binary is self-contained and requires no external dependencies for most commands.
  Use `dockflow setup` on the target Linux host, or `dockflow setup remote` from any platform to configure a remote server via SSH.
</Callout>

### Available Binaries

| Binary | Platform | Architecture |
|--------|----------|-------------|
| `dockflow-linux-x64` | Linux | x86_64 |
| `dockflow-linux-arm64` | Linux | ARM64 |
| `dockflow-macos-x64` | macOS | Intel |
| `dockflow-macos-arm64` | macOS | Apple Silicon |
| `dockflow-windows-x64.exe` | Windows | x86_64 |

## Connection Configuration

App commands require a `.env.dockflow` file at the root of your project with connection strings for each environment:

```bash
# .env.dockflow
PRODUCTION_CONNECTION=eyJob3N0Ijoi...  # Base64-encoded JSON
STAGING_CONNECTION=eyJob3N0Ijoi...
```

The connection string is generated by `dockflow setup` and contains:
- `host`: Server IP or hostname
- `port`: SSH port
- `user`: Deployment user
- `privateKey`: SSH private key
- `password`: User password (optional)

## General Commands

### Interactive Mode

```bash
dockflow
```

Starts the interactive menu for guided setup.

### Initialize Project

```bash
dockflow init                 # Interactive platform selection
dockflow init github          # GitHub Actions
dockflow init gitlab          # GitLab CI
```

Creates the `.deployment/` folder structure with CI/CD configuration.

### Deploy

```bash
dockflow deploy <env> [version]
```

Deploy the application to the specified environment.

**Examples:**
```bash
dockflow deploy production 1.0.0
dockflow deploy staging          # Auto-generated version
```

### Setup Machine

```bash
dockflow setup-machine [options]
```

Configure a server for deployments. See `dockflow setup-machine --help` for all options.

## App Commands

These commands interact with deployed services via SSH.

### Logs

View logs from running services.

```bash
dockflow logs <env> [service] [-f]
```

**Examples:**
```bash
dockflow logs production              # All services (last 50 lines each)
dockflow logs production app          # Specific service
dockflow logs production app -f       # Follow logs in real-time
```

### Exec

Execute a command inside a running container.

```bash
dockflow exec <env> <service> [command]
```

**Examples:**
```bash
dockflow exec production app bash         # Interactive shell
dockflow exec production app sh            # Alpine containers
dockflow exec production app "ls -la"      # Run command
dockflow exec production db "psql -U user" # Database access
```

### Restart

Force restart of services (rolling update).

```bash
dockflow restart <env> [service]
```

**Examples:**
```bash
dockflow restart production           # All services
dockflow restart production app       # Specific service
```

### Stop

Stop and remove the entire stack.

```bash
dockflow stop <env>
```

This will prompt for confirmation before removing all services.

### Details

Show comprehensive information about the stack.

```bash
dockflow details <env>
```

Displays:
- All services with replica status
- Running tasks
- Resource usage (CPU, memory)

### SSH

Open an interactive SSH session to the server.

```bash
dockflow ssh <env>
```

### Scale

Scale a service to a specified number of replicas.

```bash
dockflow scale <env> <service> <replicas>
```

**Examples:**
```bash
dockflow scale production app 3      # Scale to 3 replicas
dockflow scale production worker 5   # Scale workers
```

### Rollback

Rollback a service to its previous version.

```bash
dockflow rollback <env> [service]
```

**Examples:**
```bash
dockflow rollback production app     # Rollback specific service
dockflow rollback production         # Rollback all services
```

### PS

List running containers for the stack.

```bash
dockflow ps <env>
```

### Prune

Remove unused Docker resources (images, containers, volumes, networks) from the remote server.

```bash
dockflow prune <env> [options]
```

**Options:**

| Option | Description |
|--------|-------------|
| `-a, --all` | Remove all unused images, not just dangling ones |
| `--images` | Prune images only |
| `--containers` | Prune containers only |
| `--volumes` | Prune volumes only (⚠️ deletes data!) |
| `--networks` | Prune networks only |
| `-y, --yes` | Skip confirmation prompt |

**Examples:**
```bash
dockflow prune production              # Prune all resources (with confirmation)
dockflow prune production -y           # Prune all without confirmation
dockflow prune production --images     # Only prune images
dockflow prune production --images -a  # Prune ALL unused images (not just dangling)
dockflow prune production --volumes    # Only prune volumes (careful!)
```

<Callout type="warning">
  The `--volumes` option will permanently delete data stored in Docker volumes that are not currently attached to any container. Use with caution!
</Callout>

**Output:**
- Shows space reclaimed for each resource type
- Displays current disk usage after cleanup (`docker system df`)

## Requirements

- `.env.dockflow` with connection strings
- `.deployment/config.yml` with `project_name`

**For setup commands (on target Linux host):**
- Ansible (`ansible`, `ansible-playbook`)
- SSH (`ssh`, `ssh-keygen`)

## Setup Commands

### Interactive Setup

Configure a server for deployments with the interactive wizard:

```bash
dockflow setup
```

When running on Windows or macOS, the CLI will prompt you to connect to your Linux server via SSH and run the setup remotely.

### Remote Setup

Explicitly run setup on a remote Linux server from any platform:

```bash
dockflow setup remote [options]
```

**Options:**
- `--host <host>` - Remote server IP or hostname
- `--port <port>` - SSH port (default: 22)
- `--user <user>` - SSH username
- `--password <password>` - SSH password
- `--key <path>` - Path to SSH private key
- `--connection <string>` - Use existing Dockflow connection string

**Examples:**
```bash
# Interactive remote setup
dockflow setup remote

# With SSH key
dockflow setup remote --host 192.168.1.10 --user root --key ~/.ssh/id_ed25519

# With password
dockflow setup remote --host 192.168.1.10 --user root --password "secret"

# With existing connection string
dockflow setup remote --connection "eyJob3N0Ijoi..."
```

### Non-Interactive Setup (Linux only)

Configure a server without prompts (must be run directly on the target Linux host):

```bash
dockflow setup auto [options]
```

**Options:**
- `--host <host>` - Public IP/hostname for connection string
- `--port <port>` - SSH port (default: 22)
- `--user <user>` - Deployment username
- `--password <password>` - Password for new user or sudo
- `--ssh-key <path>` - Path to existing SSH private key
- `--generate-key` - Generate new SSH key
- `--skip-docker-install` - Skip Docker installation
- `--portainer` - Install Portainer
- `--portainer-port <port>` - Portainer HTTP port (default: 9000)
- `--portainer-password <password>` - Portainer admin password
- `--portainer-domain <domain>` - Portainer domain name

### Check Dependencies

Verify all required dependencies are installed:

```bash
dockflow setup check
```

### Get Connection String

Display connection string for existing deployment user:

```bash
dockflow setup connection
```

## Examples

**Full workflow:**

```bash
# 1. Setup your server (from Windows/macOS or directly on the server)
dockflow setup

# Or with remote setup explicitly
dockflow setup remote --host 192.168.1.10 --user root --key ~/.ssh/id_ed25519

# 2. Save the connection string to .env.dockflow
echo "PRODUCTION_CONNECTION=..." > .env.dockflow

# 3. Initialize project structure
dockflow init github

# 4. Deploy (via CI/CD or manually)
dockflow deploy production 1.0.0

# 5. Monitor your deployment
dockflow logs production -f
dockflow details production

# 6. Troubleshoot if needed
dockflow exec production app bash
dockflow ssh production

# 7. Scale as needed
dockflow scale production app 3

# 8. Rollback if something goes wrong
dockflow rollback production app
```
