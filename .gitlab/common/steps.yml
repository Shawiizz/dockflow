# GitLab CI common steps for Dockflow
# These templates are included by projects using Dockflow

.prepare-env:
  before_script:
    - |
      # Determine environment and version
      if [[ -n "$CI_COMMIT_TAG" ]]; then
        VERSION="$CI_COMMIT_TAG"
        ENV="${VERSION##*-}"
        [[ "$VERSION" == "$ENV" ]] && ENV="production"
      else
        ENV="production"
        VERSION="${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHA:0:8}"
      fi
      
      export ENV VERSION
      echo "Deploying to $ENV with version $VERSION"

.deploy-with-dockflow:
  script:
    - |
      # Install Dockflow CLI
      curl -fsSL https://raw.githubusercontent.com/Shawiizz/dockflow/2.0.0-dev8/install.sh | bash
      
      # Build deploy command with options
      DEPLOY_OPTS=""
      if [ "$FORCE_ACCESSORIES" = "true" ]; then
        DEPLOY_OPTS="$DEPLOY_OPTS --all"
      fi
      if [ "$SKIP_ACCESSORIES" = "true" ]; then
        DEPLOY_OPTS="$DEPLOY_OPTS --skip-accessories"
      fi
      
      dockflow deploy "$ENV" "$VERSION" $DEPLOY_OPTS
