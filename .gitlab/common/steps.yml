.prepare-env:
  before_script:
    - |
      # Determine environment and version
      if [[ -n "$CI_COMMIT_TAG" ]]; then
        VERSION="$CI_COMMIT_TAG"
        ENV="${VERSION##*-}"
        [[ "$VERSION" == "$ENV" ]] && ENV="production"
      else
        ENV="production"
        VERSION="${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHA:0:8}"
      fi
      
      export ENV VERSION

      # Clone dockflow framework to /tmp
      git clone --depth 1 --branch "$DOCKFLOW_FRAMEWORK_VERSION" "$DOCKFLOW_REPOSITORY_URL" /tmp/dockflow
      
      # Discover deployment hosts
      echo "Discovering hosts for environment: $ENV"
      export DEPLOYMENT_HOSTS=$(bash /tmp/dockflow/.common/scripts/discover_hosts.sh "$ENV" | jq -r '.[]' | tr '\n' ' ')
      echo "Deployment hosts: $DEPLOYMENT_HOSTS"

.deploy-with-ansible:
  after_script:
    - |
      # Set common environment variables
      export ROOT_PATH="$(pwd)"
      export ANSIBLE_HOST_KEY_CHECKING=False
      export PROJECT_ID="$CI_PROJECT_ID"
      
      # Determine branch name once
      if [[ -n "$CI_COMMIT_TAG" ]]; then
        BRANCH_NAME=$(git branch -r --contains "$CI_COMMIT_TAG" | grep -v "HEAD" | head -n1 | sed 's/.*origin\///')
        BRANCH_NAME="${BRANCH_NAME:-$CI_DEFAULT_BRANCH}"
      else
        BRANCH_NAME="$CI_COMMIT_REF_NAME"
      fi
      export BRANCH_NAME
      
      # Deploy to each host
      for HOST in $DEPLOYMENT_HOSTS; do
        echo "========================================="
        echo "Deploying to host: $HOST"
        echo "========================================="
        
        export HOSTNAME="$HOST"
        source /tmp/dockflow/.common/scripts/load_env.sh "$ENV" "$HOSTNAME"
        bash /tmp/dockflow/.common/scripts/deploy_with_ansible.sh
        
        echo "Deployment completed for host: $HOST"
      done
